<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø¯ÙˆØ§Ø¦ÙŠ Ø§Ù„Ø°ÙƒÙŠ</title>
    
    <!-- Google Fonts (Cairo) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for Statistics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- jsPDF for Exporting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* Use the 'Cairo' font for the entire application */
        body { 
            font-family: 'Cairo', sans-serif; 
            background-color: #f8fafc; /* Light gray background */
            transition: background-color 0.3s, color 0.3s;
        }

        /* Dark Mode Styles */
        .dark, .dark body { background-color: #111827; color: #d1d5db; }
        .dark .bg-white { background-color: #1f2937; }
        .dark .bg-gray-50 { background-color: #374151; }
        .dark .bg-gray-100 { background-color: #374151; }
        .dark .bg-gray-200 { background-color: #4b5563; }
        .dark .text-gray-800 { color: #f9fafb; }
        .dark .text-gray-700 { color: #d1d5db; }
        .dark .text-gray-600 { color: #9ca3af; }
        .dark .text-gray-500 { color: #a1a1aa; }
        .dark .text-gray-400 { color: #d1d5db; }
        .dark .border-gray-200 { border-color: #374151; }
        .dark .border { border-color: #4b5563; }
        .dark .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.25); }
        .dark .chat-received { background-color: #374151; color: #f9fafb; }
        .dark .role-selection-btn.border-white { color: #f9fafb; border-color: #f9fafb; }
        .dark .role-selection-btn.border-white:hover { background-color: #f9fafb; color: #1f2937; }
        .dark #theme-toggle .fa-moon { display: none; }
        .dark #theme-toggle .fa-sun { display: inline-block; color: #facc15; }
        #theme-toggle .fa-sun { display: none; }


        /* Smooth transition for various properties */
        .smooth-transition { 
            transition: all 0.3s ease-in-out; 
        }

        /* Base styles for views, tabs, and modals (hidden by default) */
        .view, .tab-content, .modal { 
            display: none; 
        }

        /* Show active views, tabs, and modals */
        .view.active, .tab-content.active { 
            display: block; 
        }
        .modal.active { 
            display: flex; 
        }

        /* Styling for tab buttons */
        .tab-button { 
            padding: 0.75rem 1rem; 
            border-bottom: 3px solid transparent; 
            color: #4b5563; 
        }
        .dark .tab-button { color: #9ca3af; }


        /* Styling for the active tab button */
        .tab-button.active { 
            border-bottom-color: #0d9488; /* Teal border */
            color: #0d9488; /* Teal text color */
            font-weight: 700; 
        }
        .dark .tab-button.active { color: #2dd4bf; border-bottom-color: #2dd4bf; }


        /* QR Code image styling */
        #qrcode img { 
            margin: auto; 
            border: 4px solid white; 
            border-radius: 0.5rem; 
        }

        /* Modal container styling (the overlay) */
        .modal { 
            position: fixed; 
            inset: 0; 
            align-items: center; 
            justify-content: center; 
            background-color: rgba(0,0,0,0.5); /* Semi-transparent black background */
            z-index: 50; 
        }

        /* Modal content box styling */
        .modal-content { 
            background-color: white; 
            padding: 2rem; 
            border-radius: 1rem; 
            box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25); 
            max-width: 90%; 
            width: 600px; 
            display: flex; 
            flex-direction: column; 
            max-height: 90vh; /* Ensure modal doesn't exceed viewport height */
        }
        .dark .modal-content { background-color: #1f2937; }

        /* Badge for status indicators */
        .status-badge { 
            padding: 0.25rem 0.75rem; 
            border-radius: 9999px; 
            font-size: 0.75rem; 
            font-weight: bold; 
        }

        /* QR Code video scanner styling */
        #qr-video { 
            width: 100%; 
            height: auto; 
            border-radius: 0.5rem; 
        }

        /* Chat-specific styles */
        .chat-bubble {
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            max-width: 75%;
        }
        .chat-sent {
            background-color: #0d9488; /* Teal */
            color: white;
            border-bottom-right-radius: 0.25rem;
            align-self: flex-end;
        }
        .chat-received {
            background-color: #e5e7eb; /* Gray */
            color: #1f2937;
            border-bottom-left-radius: 0.25rem;
            align-self: flex-start;
        }
        .status-normal { background-color: #d1fae5; color: #065f46; }
        .status-urgent { background-color: #fef3c7; color: #92400e; }
        .status-emergency { background-color: #fee2e2; color: #991b1b; }
        .date-separator {
            text-align: center;
            color: #6b7280;
            font-size: 0.875rem;
            margin: 1rem 0;
        }
        .dark .date-separator { color: #9ca3af; }
        
        /* Rating Stars */
        .rating-stars .fa-star {
            cursor: pointer;
            color: #d1d5db; /* Gray stars by default */
            transition: color 0.2s;
        }
        .rating-stars .fa-star.selected,
        .rating-stars:hover .fa-star:hover,
        .rating-stars .fa-star:hover ~ .fa-star {
            color: #facc15; /* Yellow for selected/hovered */
        }
        .rating-stars:hover .fa-star {
             color: #facc15;
        }

        /* Loading spinner for buttons */
        .btn-loading {
            position: relative;
            pointer-events: none; /* Disable clicks during loading */
        }
        .btn-loading .spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 0.5rem; /* Space between spinner and text */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Notification Area -->
    <div id="notification" class="fixed top-0 left-1/2 -translate-x-1/2 w-full max-w-md p-4 rounded-b-lg shadow-lg text-white text-center z-[100] transition-transform duration-300 -translate-y-full">
        <p id="notification-message"></p>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-white bg-opacity-80 z-[100] flex-col justify-center items-center">
        <i class="fas fa-spinner fa-spin text-teal-500 text-4xl"></i>
        <p class="mt-4 text-lg text-gray-700">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
    </div>

    <!-- Main App Container -->
    <div id="app" class="min-h-screen">
        <!-- App Header (Visible when logged in) -->
        <header id="appHeader" class="hidden bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-40">
            <h1 class="text-2xl font-bold text-teal-600">Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø¯ÙˆØ§Ø¦ÙŠ</h1>
            <div class="flex items-center gap-4">
                <button id="theme-toggle" class="text-gray-500 hover:text-teal-600 text-xl">
                    <i class="fas fa-moon"></i>
                    <i class="fas fa-sun"></i>
                </button>
                <span id="userEmailDisplay" class="text-sm text-gray-600 hidden md:block"></span>
                <button id="logoutButton" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600">
                    <i class="fa-solid fa-right-from-bracket"></i>
                    <span class="hidden md:inline ml-2">Ø®Ø±ÙˆØ¬</span>
                </button>
            </div>
        </header>

        <!-- Main content area where views are rendered -->
        <main>
            <div id="homeView" class="view"></div>
            <div id="authView" class="view"></div>
            <div id="resetPasswordView" class="view"></div>
            <div id="patientDashboardView" class="view p-4 md:p-8"></div>
            <div id="doctorDashboardView" class="view p-4 md:p-8"></div>
        </main>
        
        <!-- Modals -->
        <div id="aiModal" class="modal"></div>
        <div id="doctorModal" class="modal"></div>
        <div id="medicationFormModal" class="modal"></div>
        <div id="chatModal" class="modal"></div>
        <div id="confirmationModal" class="modal"></div>
        <div id="policyModal" class="modal"></div>
        <div id="twoFactorAuthModal" class="modal"></div>
        <div id="ratingModal" class="modal"></div>

    </div>

    <!-- QR Code Generation Libraries -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    
    <!-- Main Application Logic -->
    <script type="module">
        // Import Firebase services at the top level of the module
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, query, onSnapshot, addDoc, where, writeBatch, serverTimestamp, getDocs, arrayUnion, deleteDoc, orderBy, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Check if the app is running from a local file
        if (window.location.protocol === 'file:') {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen flex flex-col items-center justify-center bg-red-100 text-red-800 p-8 text-center">
                    <i class="fas fa-exclamation-triangle text-5xl mb-4"></i>
                    <h1 class="text-3xl font-bold mb-2">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„</h1>
                    <p class="text-xl max-w-2xl">
                        Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ù…Ù„Ù Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ. Ù‡Ø°Ø§ ÙŠØ³Ø¨Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø£Ù…Ø§Ù† (CORS) ØªÙ…Ù†Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….
                    </p>
                    <p class="mt-4 text-lg font-semibold">Ø§Ù„Ø­Ù„:</p>
                    <p class="text-lg max-w-2xl">
                        ÙŠØ¬Ø¨ ØªØ´ØºÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø®Ù„Ø§Ù„ Ø®Ø§Ø¯Ù… ÙˆÙŠØ¨ Ù…Ø­Ù„ÙŠ. Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ³ØªØ®Ø¯Ù… Ù…Ø­Ø±Ø± Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Visual Studio CodeØŒ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ«Ø¨ÙŠØª Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ø³Ù… "Live Server" ÙˆØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù‡Ø§ Ø¨Ø³Ù‡ÙˆÙ„Ø©.
                    </p>
                </div>
            `;
        } else {
            // --- NORMAL APP INITIALIZATION ---

            // --- 1. CONFIGURATION & INITIALIZATION ---
            
            // IMPORTANT SECURITY NOTE:
            // ÙÙŠ Ø¨ÙŠØ¦Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬ØŒ ÙŠØ¬Ø¨ Ø£Ù„Ø§ ÙŠØªÙ… Ø¹Ø±Ø¶ Ù…ÙØ§ØªÙŠØ­ API Ø§Ù„Ø­Ø³Ø§Ø³Ø© (Ù…Ø«Ù„ Ù…ÙØªØ§Ø­ Gemini API) Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„.
            // ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªÙ… ØªØ®Ø²ÙŠÙ† Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù† Ø¹Ù„Ù‰ Ø®Ø§Ø¯Ù… Ø®Ù„ÙÙŠ (Ù…Ø«Ù„ Firebase Cloud Functions)
            // ÙˆÙŠØ¬Ø¨ Ø£Ù† ØªØªÙ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙŠ ØªØªØ·Ù„Ø¨ Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø¹Ø¨Ø± Ù‡Ø°Ø§ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø®Ù„ÙÙŠ.
            // ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø«Ø§Ù„ØŒ Ø³Ù†Ù‚ÙˆÙ… Ø¨Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø®Ù„ÙÙŠ Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ.
            // const GEMINI_API_KEY = ""; // ØªÙ… Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØºÙŠØ± Ù„Ø£Ù†Ù‡ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø®Ù„ÙÙŠ

            const firebaseConfig = {
                apiKey: "AIzaSyBxC0CPZzfoVviBM2UDEEamWwsJCw5cuqY", // Ù‡Ø°Ø§ Ø§Ù„Ù…ÙØªØ§Ø­ Ù„ÙŠØ³ Ø³Ø±ÙŠÙ‹Ø§ ÙˆÙ„ÙƒÙ†Ù‡ ÙŠØ±Ø¨Ø· ØªØ·Ø¨ÙŠÙ‚Ùƒ Ø¨Ù…Ø´Ø±ÙˆØ¹ Firebase
                authDomain: "my-app-9b541.firebaseapp.com",
                projectId: "my-app-9b541",
                storageBucket: "my-app-9b541.appspot.com",
                messagingSenderId: "895299955644",
                appId: "1:895299955644:web:e0a9a1d3f2b8c6d7e9f0b1"
            };

            // This APP_ID is used for Firestore collection paths to scope data to this specific application.
            // It's good practice for multi-app Firebase projects.
            const APP_ID = 'default-medication-app';

            // Initialize Firebase services
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const storage = getStorage(app);

            // --- 2. GLOBAL STATE & UI ELEMENTS ---
            let activeListeners = []; // Stores unsubscribe functions for Firestore listeners
            let appState = { // Centralized state object for easier management
                currentAuthRole: 'patient',
                currentUser: null,
                currentUserData: null
            };

            const loadingOverlay = document.getElementById('loading-overlay');
            const views = {
                home: document.getElementById('homeView'),
                auth: document.getElementById('authView'),
                resetPassword: document.getElementById('resetPasswordView'),
                patientDashboard: document.getElementById('patientDashboardView'),
                doctorDashboard: document.getElementById('doctorDashboardView'),
            };
            const appHeader = document.getElementById('appHeader');

            // --- 3. CORE UI HELPER FUNCTIONS ---

            /**
             * Shows or hides a global loading overlay.
             * @param {boolean} show - True to show, false to hide.
             */
            function showLoading(show) {
                loadingOverlay.classList.toggle('hidden', !show);
                loadingOverlay.classList.toggle('flex', show);
            }

            /**
             * Shows or hides a loading spinner on a specific button.
             * @param {HTMLElement} button - The button element.
             * @param {boolean} show - True to show spinner, false to hide.
             * @param {string} originalText - The original text of the button.
             */
            function showButtonLoading(button, show, originalText = '') {
                if (show) {
                    button.dataset.originalText = originalText || button.textContent;
                    button.innerHTML = '<span class="spinner"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
                    button.classList.add('btn-loading');
                    button.disabled = true;
                } else {
                    button.innerHTML = button.dataset.originalText || '';
                    button.classList.remove('btn-loading');
                    button.disabled = false;
                }
            }

            /**
             * Activates a specific view and deactivates others.
             * @param {string} viewName - The ID of the view to activate.
             */
            function showView(viewName) {
                Object.values(views).forEach(v => v.classList.remove('active'));
                if (views[viewName]) {
                    views[viewName].classList.add('active');
                }
                // Hide header for auth/home/reset views
                appHeader.classList.toggle('hidden', ['home', 'auth', 'resetPassword'].includes(viewName));
                showLoading(false); // Hide global loading after view is rendered
            }

            /**
             * Displays a temporary notification message at the top of the screen.
             * @param {string} message - The message to display.
             * @param {'success'|'error'} type - The type of notification (determines color).
             */
            function showNotification(message, type = 'success') {
                const notification = document.getElementById('notification');
                const messageEl = document.getElementById('notification-message');

                messageEl.textContent = message;
                // Remove existing color classes and add the new one
                notification.className = notification.className.replace(/bg-\w+-\d+/, ''); 
                notification.classList.add(type === 'success' ? 'bg-teal-500' : 'bg-red-500');

                // Animate the notification into view
                notification.style.transform = 'translate(-50%, 0)';
                // Hide after 3 seconds
                setTimeout(() => {
                    notification.style.transform = 'translate(-50%, -100%)';
                }, 3000);
            }

            /**
             * Cleans up all active Firestore listeners to prevent memory leaks.
             */
            function cleanupListeners() {
                activeListeners.forEach(unsubscribe => unsubscribe());
                activeListeners = [];
            }
            
            /**
             * Renders a generic confirmation modal.
             * @param {string} message - The confirmation message.
             * @param {Function} onConfirm - Callback function to execute if confirmed.
             */
            function renderConfirmationModal(message, onConfirm) {
                const modal = document.getElementById('confirmationModal');
                modal.innerHTML = `
                    <div class="modal-content">
                        <p class="text-lg text-center mb-6">${message}</p>
                        <div class="flex gap-4">
                            <button id="confirm-btn" class="flex-1 bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700">ØªØ£ÙƒÙŠØ¯</button>
                            <button id="cancel-btn" class="flex-1 bg-gray-300 text-gray-800 font-bold py-3 rounded-lg hover:bg-gray-400">Ø¥Ù„ØºØ§Ø¡</button>
                        </div>
                    </div>
                `;
                modal.classList.add('active');

                // Event listener for clicking outside the modal content to close it
                modal.addEventListener('click', function handler(e) {
                    if (e.target === modal) { // Only close if clicking on the overlay itself
                        modal.classList.remove('active');
                        modal.removeEventListener('click', handler); // Remove listener after use
                    }
                });

                modal.querySelector('#confirm-btn').addEventListener('click', () => {
                    onConfirm();
                    modal.classList.remove('active');
                });
                modal.querySelector('#cancel-btn').addEventListener('click', () => {
                    modal.classList.remove('active');
                });
            }
            
            // --- THEME/DARK MODE ---
            /**
             * Applies the specified theme to the document.
             * @param {'light'|'dark'} theme - The theme to apply.
             */
            function applyTheme(theme) {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }

            /**
             * Toggles between light and dark themes and saves preference to localStorage.
             */
            function toggleTheme() {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            }

            // --- 4. AUTHENTICATION & ROUTING ---

            /**
             * Listens for Firebase authentication state changes and updates UI accordingly.
             */
            onAuthStateChanged(auth, async (user) => {
                cleanupListeners(); // Clear all previous listeners on auth state change
                if (user && !user.isAnonymous) {
                    showLoading(true);
                    appState.currentUser = user;
                    const userDocRef = doc(db, `/artifacts/${APP_ID}/users`, user.uid);
                    try {
                        const userDoc = await getDoc(userDocRef);
                        if (userDoc.exists()) {
                            appState.currentUserData = userDoc.data();
                            document.getElementById('userEmailDisplay').textContent = user.email;
                            if (appState.currentUserData.role === 'patient') {
                                renderTabView(views.patientDashboard, patientTabs, 'meds', appState.currentUser, appState.currentUserData);
                                showView('patientDashboard');
                            } else if (appState.currentUserData.role === 'doctor') {
                                renderTabView(views.doctorDashboard, doctorTabs, 'patients', appState.currentUser, appState.currentUserData);
                                setupDoctorNotificationListeners(user.uid);
                                showView('doctorDashboard');
                            }
                        } else {
                            showNotification("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©. ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬.", "error");
                            await signOut(auth);
                        }
                    } catch (error) {
                        console.error("Auth state change error:", error);
                        showNotification("Ø­Ø¯Ø« Ø®Ø·Ø£. ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬.", "error");
                        await signOut(auth);
                    }
                } else {
                    appState.currentUser = null;
                    appState.currentUserData = null;
                    renderHomeView();
                    showView('home');
                }
            });

            // --- 5. VIEW RENDERING ---

            /**
             * Renders a tabbed interface within a given container.
             * @param {HTMLElement} container - The HTML element to render tabs into.
             * @param {Object} tabsConfig - Configuration object for tabs.
             * @param {string} initialTab - The key of the tab to show initially.
             * @param {Object} user - Firebase User object.
             * @param {Object} userData - Custom user data from Firestore.
             */
            function renderTabView(container, tabsConfig, initialTab, user, userData) {
                const tabButtons = Object.keys(tabsConfig).map(key => 
                    `<button class="tab-button" data-tab="${key}">${tabsConfig[key].icon} ${tabsConfig[key].title}</button>`
                ).join('');

                container.innerHTML = `
                    <div class="border-b border-gray-200 mb-6">
                        <nav class="-mb-px flex flex-wrap gap-6" aria-label="Tabs">${tabButtons}</nav>
                    </div>
                    <div id="tab-content-container">
                        ${Object.keys(tabsConfig).map(key => `<div class="tab-content" id="tab-${key}"></div>`).join('')}
                    </div>
                `;

                const tabButtonElements = container.querySelectorAll('.tab-button');
                const tabContentElements = container.querySelectorAll('.tab-content');

                const switchTab = (tabKey) => {
                    tabButtonElements.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabKey));
                    tabContentElements.forEach(content => content.classList.toggle('active', content.id === `tab-${tabKey}`));
                    // Call the onRender function for the active tab
                    tabsConfig[tabKey].onRender(document.getElementById(`tab-${tabKey}`), user, userData);
                };

                container.querySelector('nav').addEventListener('click', (e) => {
                    const button = e.target.closest('.tab-button');
                    if (button) {
                        switchTab(button.dataset.tab);
                    }
                });

                // Set initial active tab
                switchTab(initialTab);
            }

            // --- 6. PATIENT DASHBOARD ---

            const patientTabs = {
                meds: { title: "Ø£Ø¯ÙˆÙŠØªÙŠ", icon: '<i class="fas fa-pills"></i>', onRender: renderPatientMedsTab },
                history: { title: "Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©", icon: '<i class="fas fa-history"></i>', onRender: renderMedicationHistoryTab },
                myDoctors: { title: "Ø£Ø·Ø¨Ø§Ø¦ÙŠ", icon: '<i class="fas fa-user-md"></i>', onRender: renderPatientDoctorsTab },
                profile: { title: "Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ", icon: '<i class="fas fa-user-edit"></i>', onRender: renderPatientProfileTab },
                requests: { title: "Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø±Ø¨Ø·", icon: '<i class="fas fa-user-friends"></i>', onRender: renderPatientRequestsTab },
            };

            /**
             * Renders the patient's current medications tab.
             * @param {HTMLElement} container - The container element for the tab.
             * @param {Object} user - Firebase User object.
             */
            function renderPatientMedsTab(container, user) {
                const dosageOptions = ["1 Ø­Ø¨Ø©", "2 Ø­Ø¨Ø©", "Ù†ØµÙ Ø­Ø¨Ø©", "5 Ù…Ù„", "10 Ù…Ù„", "Ø¬Ø±Ø¹Ø© ÙˆØ§Ø­Ø¯Ø©"];
                // Frequency options for dynamic time inputs
                const frequencyOptions = { 1: "Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙŠÙˆÙ…ÙŠØ§Ù‹", 2: "Ù…Ø±ØªÙŠÙ† ÙŠÙˆÙ…ÙŠØ§Ù‹", 3: "3 Ù…Ø±Ø§Øª ÙŠÙˆÙ…ÙŠØ§Ù‹", 4: "4 Ù…Ø±Ø§Øª ÙŠÙˆÙ…ÙŠØ§Ù‹"};

                container.innerHTML = `
                    <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
                        <h3 class="text-xl font-bold mb-6">Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ§Ø¡ Ø¬Ø¯ÙŠØ¯</h3>
                        <form id="addMedForm" class="space-y-4">
                            <input id="medName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡" class="w-full p-3 border rounded-lg" required>
                            <select id="medDosage" class="w-full p-3 border rounded-lg">${dosageOptions.map(o => `<option value="${o}">${o}</option>`).join('')}</select>
                            <select id="medFrequency" class="w-full p-3 border rounded-lg"><option value="">ÙƒÙ… Ù…Ø±Ø© ÙÙŠ Ø§Ù„ÙŠÙˆÙ…ØŸ</option>${Object.entries(frequencyOptions).map(([val, text]) => `<option value="${val}">${text}</option>`).join('')}</select>
                            <div id="medTimesContainer" class="grid grid-cols-2 md:grid-cols-4 gap-4 hidden"></div>
                            <textarea id="medInstructions" placeholder="ØªØ¹Ù„ÙŠÙ…Ø§Øª ÙˆØªØ­Ø°ÙŠØ±Ø§Øª" class="w-full p-3 border rounded-lg h-24"></textarea>
                            <button type="submit" id="addMedSubmitBtn" class="w-full bg-teal-600 text-white font-bold py-3 rounded-lg hover:bg-teal-700">Ø­ÙØ¸ Ø§Ù„Ø¯ÙˆØ§Ø¡</button>
                        </form>
                    </div>
                    <div>
                         <div class="flex justify-between items-center mb-6">
                             <h3 class="text-xl font-bold">Ù‚Ø§Ø¦Ù…Ø© Ø£Ø¯ÙˆÙŠØªÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
                             <button id="enable-reminders" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600"><i class="fas fa-bell mr-2"></i>ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</button>
                         </div>
                        <div id="medicationsList" class="space-y-4"><p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©...</p></div>
                    </div>`;
                
                container.querySelector('#enable-reminders').addEventListener('click', () => {
                    showNotification("Ø³ÙŠØªÙ… ØªØ°ÙƒÙŠØ±Ùƒ Ø¨Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø¯ÙˆØ§Ø¦Ùƒ (Ù…ÙŠØ²Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©).", "success");
                });
                
                const medFrequencySelect = container.querySelector('#medFrequency');
                const medTimesContainer = container.querySelector('#medTimesContainer');
                
                // Event listener for frequency select to dynamically generate time inputs
                medFrequencySelect.addEventListener('change', (e) => {
                    const count = parseInt(e.target.value, 10);
                    medTimesContainer.innerHTML = ''; // Clear previous inputs
                    const timePresets = [{icon:'â˜€ï¸', label:'ØµØ¨Ø§Ø­Ø§Ù‹'}, {icon:'ğŸ•›', label:'Ø¸Ù‡Ø±Ø§Ù‹'}, {icon:'ğŸŒ™', label:'Ù…Ø³Ø§Ø¡Ù‹'}, {icon:'ğŸ›Œ', label:'Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…'}];
                    if (count > 0) {
                        medTimesContainer.classList.remove('hidden');
                        for (let i = 0; i < count; i++) {
                            const preset = timePresets[i] || {icon: 'â°', label: `Ø§Ù„ÙˆÙ‚Øª ${i+1}`};
                            medTimesContainer.innerHTML += `<div class="flex items-center gap-2"><label class="w-28">${preset.icon} ${preset.label}</label><input type="time" class="med-time-input flex-1 p-2 border rounded-lg" required></div>`;
                        }
                    } else {
                        medTimesContainer.classList.add('hidden');
                    }
                });

                // Handle form submission for adding new medication
                container.querySelector('#addMedForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const submitBtn = e.submitter; // The button that triggered the submit
                    showButtonLoading(submitBtn, true, 'Ø­ÙØ¸ Ø§Ù„Ø¯ÙˆØ§Ø¡');

                    // SECURITY NOTE: Perform server-side validation and sanitization for all user inputs
                    // before saving to Firestore. This client-side validation is for basic UX.
                    const medData = {
                        name: container.querySelector('#medName').value,
                        dosage: container.querySelector('#medDosage').value,
                        instructions: container.querySelector('#medInstructions').value,
                        times: Array.from(container.querySelectorAll('.med-time-input')).map(input => input.value),
                        createdAt: serverTimestamp(),
                        addedBy: 'patient',
                        status: 'active', // New field for active/archived medications
                        takenDates: [] // New field to track taken doses
                    };
                    
                    try {
                        const medRef = collection(db, `/artifacts/${APP_ID}/users/${user.uid}/medications`);
                        await addDoc(medRef, medData);
                        showNotification("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆØ§Ø¡ Ø¨Ù†Ø¬Ø§Ø­!");
                        e.target.reset(); // Reset the form
                        medTimesContainer.classList.add('hidden'); // Hide time inputs after reset
                    } catch (error) {
                        console.error("Error adding medication:", error);
                        showNotification("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆØ§Ø¡.", "error");
                    } finally {
                        showButtonLoading(submitBtn, false);
                    }
                });

                // Listen for real-time updates to the patient's active medications
                const medsQuery = query(collection(db, `/artifacts/${APP_ID}/users/${user.uid}/medications`), where("status", "==", "active"));
                const medsListener = onSnapshot(medsQuery, (snapshot) => {
                    const listEl = document.getElementById('medicationsList');
                    if(!listEl) return; // Ensure element exists before updating
                    listEl.innerHTML = '';
                    if(snapshot.empty) {
                        listEl.innerHTML = `<p class="text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¯ÙˆÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>`;
                        return;
                    }
                    
                    snapshot.docs.forEach(docSnap => {
                        const med = docSnap.data();
                        const item = document.createElement('div');
                        item.className = 'bg-white p-4 rounded-lg shadow-sm';
                        // Display taken count and add "Mark as Taken" button
                        item.innerHTML = `<div class="flex justify-between items-start">
                                    <div>
                                        <h4 class="font-bold text-lg">${med.name}</h4>
                                        <p class="text-sm text-gray-600">${med.dosage} | ${med.times.join(', ')}</p>
                                        ${med.addedBy === 'doctor' ? '<p class="text-xs text-teal-600 font-bold mt-1">ØªÙ…Øª Ø¥Ø¶Ø§ÙØªÙ‡ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨</p>' : ''}
                                        <p class="text-xs text-gray-500 mt-1">ØªÙ… Ø£Ø®Ø° Ø§Ù„Ø¬Ø±Ø¹Ø§Øª: ${med.takenDates?.length || 0}</p>
                                    </div>
                                    <div class="flex items-center gap-4">
                                        <button data-med-id="${docSnap.id}" class="mark-taken-btn text-green-500 hover:text-green-700" title="ØªÙ… Ø£Ø®Ø° Ø§Ù„Ø¬Ø±Ø¹Ø©"><i class="fas fa-check-circle text-xl"></i></button>
                                        <button data-med-id="${docSnap.id}" class="archive-med-btn text-gray-500 hover:text-red-600" title="Ø£Ø±Ø´ÙØ© Ø§Ù„Ø¯ÙˆØ§Ø¡"><i class="fas fa-archive"></i></button>
                                        <button data-med-name="${med.name}" class="ai-info-btn text-sky-600 hover:text-sky-800" title="Ø´Ø±Ø­ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ"><i class="fas fa-robot text-xl"></i></button>
                                    </div>
                                </div>`;
                        listEl.appendChild(item);
                    });

                    // Add event listeners for dynamically created buttons
                    listEl.querySelectorAll('.ai-info-btn').forEach(btn => btn.addEventListener('click', (e) => explainMedWithAI(e.currentTarget.dataset.medName)));
                    listEl.querySelectorAll('.archive-med-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                        const medId = e.currentTarget.dataset.medId;
                        try {
                            await updateDoc(doc(db, `/artifacts/${APP_ID}/users/${user.uid}/medications`, medId), { status: 'archived' });
                            showNotification("ØªÙ…Øª Ø£Ø±Ø´ÙØ© Ø§Ù„Ø¯ÙˆØ§Ø¡.", "success");
                        } catch (error) {
                            console.error("Error archiving medication:", error);
                            showNotification("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø£Ø±Ø´ÙØ© Ø§Ù„Ø¯ÙˆØ§Ø¡.", "error");
                        }
                    }));
                    listEl.querySelectorAll('.mark-taken-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                        const medId = e.currentTarget.dataset.medId;
                        try {
                            await updateDoc(doc(db, `/artifacts/${APP_ID}/users/${user.uid}/medications`, medId), {
                                arrayUnion: arrayUnion(serverTimestamp()) // Add current timestamp to takenDates array
                            });
                            showNotification("ØªÙ… ØªØ³Ø¬ÙŠÙ„ ØªÙ†Ø§ÙˆÙ„ Ø§Ù„Ø¬Ø±Ø¹Ø©.", "success");
                        } catch (error) {
                            console.error("Error marking medication as taken:", error);
                            showNotification("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ø±Ø¹Ø©.", "error");
                        }
                    }));
                });
                activeListeners.push(medsListener); // Add listener to activeListeners array for cleanup
            }

            /**
             * Renders the patient's medication history tab (archived medications).
             * @param {HTMLElement} container - The container element for the tab.
             * @param {Object} user - Firebase User object.
             */
            function renderMedicationHistoryTab(container, user) {
                container.innerHTML = `<div id="med-history-list" class="space-y-4"><p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„...</p></div>`;
                const listEl = container.querySelector('#med-history-list');
                // Query for archived medications
                const medsQuery = query(collection(db, `/artifacts/${APP_ID}/users/${user.uid}/medications`), where("status", "==", "archived"));
                
                const listener = onSnapshot(medsQuery, (snapshot) => {
                    listEl.innerHTML = '';
                    if (snapshot.empty) {
                        listEl.innerHTML = `<p class="text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¯ÙˆÙŠØ© ÙÙŠ Ø§Ù„Ø³Ø¬Ù„.</p>`;
                        return;
                    }
                    snapshot.docs.forEach(docSnap => {
                        const med = docSnap.data();
                        const item = document.createElement('div');
                        item.className = 'bg-white p-4 rounded-lg shadow-sm opacity-70'; // Slightly faded for archived
                        item.innerHTML = `<h4 class="font-bold text-lg">${med.name}</h4><p class="text-sm text-gray-600">${med.dosage}</p>`;
                        listEl.appendChild(item);
                    });
                });
                activeListeners.push(listener);
            }

            /**
             * Renders the patient's linked doctors tab.
             * @param {HTMLElement} container - The container element for the tab.
             * @param {Object} user - Firebase User object.
             * @param {Object} userData - Patient's custom user data.
             */
            function renderPatientDoctorsTab(container, user, userData) {
                container.innerHTML = `<div id="doctors-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"><p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡...</p></div>`;
                const listEl = container.querySelector('#doctors-list');

                if (!userData.linkedDoctors || userData.linkedDoctors.length === 0) {
                    listEl.innerHTML = `<p class="text-center text-gray-500 col-span-full">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø¯ÙŠÙƒ Ø£Ø·Ø¨Ø§Ø¡ Ù…Ø±ØªØ¨Ø·ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹.</p>`;
                    return;
                }

                listEl.innerHTML = '';
                userData.linkedDoctors.forEach(async (doctorId) => {
                    const doctorDocRef = doc(db, `/artifacts/${APP_ID}/users`, doctorId);
                    const doctorDoc = await getDoc(doctorDocRef);
                    if (doctorDoc.exists()) {
                        const doctor = doctorDoc.data();
                        const item = document.createElement('div');
                        item.className = 'bg-white p-4 rounded-lg shadow-sm flex flex-col justify-between';
                        item.innerHTML = `
                            <div>
                                <h4 class="font-bold text-lg">${doctor.name || 'Ø·Ø¨ÙŠØ¨ ØºÙŠØ± Ù…Ø³Ù…Ù‰'}</h4>
                                <p class="text-sm text-gray-600">${doctor.specialty || 'Ø¨Ø¯ÙˆÙ† ØªØ®ØµØµ'}</p>
                                <p class="text-xs text-gray-400 mt-1">${doctor.email}</p>
                            </div>
                            <div class="mt-4 flex gap-2">
                                <button data-doctor-id="${doctorId}" class="chat-btn flex-1 bg-teal-500 text-white py-2 rounded-lg hover:bg-teal-600"><i class="fas fa-comments mr-2"></i>Ù…Ø±Ø§Ø³Ù„Ø©</button>
                                <button data-doctor-id="${doctorId}" data-doctor-name="${doctor.name || 'Ø·Ø¨ÙŠØ¨'}" class="rate-btn flex-1 bg-yellow-500 text-white py-2 rounded-lg hover:bg-yellow-600"><i class="fas fa-star mr-2"></i>ØªÙ‚ÙŠÙŠÙ…</button>
                            </div>
                        `;
                        listEl.appendChild(item);
                    }
                });

                // Event delegation for chat and rate buttons
                listEl.addEventListener('click', (e) => {
                    const chatBtn = e.target.closest('.chat-btn');
                    const rateBtn = e.target.closest('.rate-btn');
                    if(chatBtn) {
                        const doctorId = chatBtn.dataset.doctorId;
                        renderChatModal(user.uid, doctorId); // Patient's UID, Doctor's UID
                    }
                    if(rateBtn) {
                        const { doctorId, doctorName } = rateBtn.dataset;
                        renderRatingModal(doctorId, doctorName);
                    }
                });
            }

            /**
             * Renders the patient's profile tab.
             * @param {HTMLElement} container - The container element for the tab.
             * @param {Object} user - Firebase User object.
             * @param {Object} userData - Patient's custom user data.
             */
            function renderPatientProfileTab(container, user, userData) {
                container.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <h3 class="text-xl font-bold mb-6">Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©</h3>
                            <div class="mb-4">
                                <label class="font-bold text-gray-600">Ø±Ù…Ø² Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© (UID):</label>
                                <p class="text-lg text-teal-600 font-mono select-all">${user.uid}</p>
                                <p class="text-xs text-gray-500">Ø´Ø§Ø±Ùƒ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù…Ø² Ù…Ø¹ Ø·Ø¨ÙŠØ¨Ùƒ Ù„ÙŠØªÙ…ÙƒÙ† Ù…Ù† Ù…ØªØ§Ø¨Ø¹ØªÙƒ.</p>
                            </div>
                            <form id="profileForm" class="space-y-4">
                                <input id="profileName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" class="w-full p-3 border rounded-lg" value="${userData.name || ''}">
                                <input id="profileAge" type="number" placeholder="Ø§Ù„Ø¹Ù…Ø±" class="w-full p-3 border rounded-lg" value="${userData.age || ''}">
                                <textarea id="profileConditions" placeholder="Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„ØµØ­ÙŠØ© (Ø¥Ù† ÙˆØ¬Ø¯Øª)" class="w-full p-3 border rounded-lg h-24">${userData.conditions || ''}</textarea>
                                <button type="submit" id="saveProfileBtn" class="mt-2 w-full bg-teal-600 text-white font-bold py-3 rounded-lg hover:bg-teal-700">Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</button>
                            </form>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">Ø§Ù„Ø£Ù…Ø§Ù†</h3>
                            <div class="flex justify-between items-center">
                                <span>Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø®Ø·ÙˆØªÙŠÙ†</span>
                                <button id="setup-2fa-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">${userData.is2FAEnabled ? 'ØªØ¹Ø·ÙŠÙ„' : 'ØªÙØ¹ÙŠÙ„'}</button>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">Ø²ÙŠØ§Ø¯Ø© Ø£Ù…Ø§Ù† Ø­Ø³Ø§Ø¨Ùƒ. (Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ù‡ÙŠ Ù…Ø­Ø§ÙƒØ§Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©).</p>
                        </div>
                    </div>
                `;
                
                container.querySelector('#setup-2fa-btn').addEventListener('click', () => {
                    render2FASetupModal(user.uid, userData.is2FAEnabled);
                });

                container.querySelector('#profileForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const submitBtn = e.submitter;
                    showButtonLoading(submitBtn, true, 'Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª');

                    // SECURITY NOTE: Perform server-side validation and sanitization for all user inputs
                    // before saving to Firestore. This client-side validation is for basic UX.
                    const profileData = {
                        name: container.querySelector('#profileName').value,
                        age: container.querySelector('#profileAge').value,
                        conditions: container.querySelector('#profileConditions').value
                    };
                    const userDocRef = doc(db, `/artifacts/${APP_ID}/users`, user.uid);
                    try {
                        await updateDoc(userDocRef, profileData);
                        showNotification("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
                    } catch (error) {
                        console.error("Error saving profile:", error);
                        showNotification("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª.", "error");
                    } finally {
                        showButtonLoading(submitBtn, false);
                    }
                });
            }

            /**
             * Renders the patient's connection requests tab.
             * @param {HTMLElement} container - The container element for the tab.
             * @param {Object} user - Firebase User object.
             */
            function renderPatientRequestsTab(container, user) {
                container.innerHTML = `<div id="requests-list" class="space-y-4"><p class="text-center text-gray-500">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p></div>`;
                const listEl = container.querySelector('#requests-list');

                const requestsRef = collection(db, `/artifacts/${APP_ID}/public/data/connectionRequests`);
                // Query for pending requests sent to the current patient
                const q = query(requestsRef, where("to", "==", user.uid), where("status", "==", "pending"));
                
                const requestsListener = onSnapshot(q, (snapshot) => {
                    listEl.innerHTML = ''; // Clear existing list
                    if (snapshot.empty) {
                        listEl.innerHTML = `<p class="text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø±Ø¨Ø· Ø¬Ø¯ÙŠØ¯Ø©.</p>`;
                        return;
                    }
                    
                    snapshot.docs.forEach(async (docSnap) => {
                        const request = docSnap.data();
                        const doctorDoc = await getDoc(doc(db, `/artifacts/${APP_ID}/users`, request.from));
                        const doctorEmail = doctorDoc.exists() ? doctorDoc.data().email : "Ø·Ø¨ÙŠØ¨ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
                        
                        const item = document.createElement('div');
                        item.className = 'bg-white p-4 rounded-lg shadow-sm flex justify-between items-center flex-wrap gap-2';
                        item.innerHTML = `
                            <p>Ø·Ù„Ø¨ Ø±Ø¨Ø· Ù…Ù† Ø§Ù„Ø·Ø¨ÙŠØ¨: <span class="font-bold">${doctorEmail}</span></p>
                            <div class="flex gap-2">
                                <button data-id="${docSnap.id}" data-action="accept" class="request-btn bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600">Ù‚Ø¨ÙˆÙ„</button>
                                <button data-id="${docSnap.id}" data-action="decline" class="request-btn bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600">Ø±ÙØ¶</button>
                            </div>`;
                        listEl.appendChild(item);
                    });
                });

                listEl.addEventListener('click', (e) => {
                    const button = e.target.closest('.request-btn');
                    if (button) {
                        const requestId = button.dataset.id;
                        const action = button.dataset.action;
                        handleConnectionRequest(requestId, action === 'accept');
                    }
                });

                activeListeners.push(requestsListener);
            }

            /**
             * Handles accepting or declining a connection request.
             * @param {string} requestId - The ID of the connection request document.
             * @param {boolean} accepted - True if accepted, false if declined.
             */
            async function handleConnectionRequest(requestId, accepted) {
                const requestRef = doc(db, `/artifacts/${APP_ID}/public/data/connectionRequests`, requestId);
                const requestDoc = await getDoc(requestRef);
                if (!requestDoc.exists()) {
                    showNotification("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨.", "error");
                    return;
                }

                try {
                    if (accepted) {
                        const { from, to } = requestDoc.data();
                        const batch = writeBatch(db);
                        
                        batch.update(requestRef, { status: "accepted" });
                        batch.update(doc(db, `/artifacts/${APP_ID}/users`, from), { linkedPatients: arrayUnion(to) });
                        batch.update(doc(db, `/artifacts/${APP_ID}/users`, to), { linkedDoctors: arrayUnion(from) });
                        
                        await batch.commit();
                        showNotification("ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨ Ø§Ù„Ø±Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­!");
                    } else {
                        await updateDoc(requestRef, { status: "declined" });
                        showNotification("ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨ Ø§Ù„Ø±Ø¨Ø·.");
                    }
                } catch (error) {
                    console.error("Error handling connection request:", error);
                    showNotification("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨.", "error");
                }
            }

            // --- 7. DOCTOR DASHBOARD ---

            const doctorTabs = {
                patients: { title: "Ù…Ø±Ø¶Ø§ÙŠ", icon: '<i class="fas fa-users"></i>', onRender: renderDoctorPatientsTab },
                addPatient: { title: "Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø±Ø¨Ø·", icon: '<i class="fas fa-user-plus"></i>', onRender: renderDoctorAddPatientTab },
                profile: { title: "Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ", icon: '<i class="fas fa-user-cog"></i>', onRender: renderDoctorProfileTab },
                stats: { title: "Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª", icon: '<i class="fas fa-chart-line"></i>', onRender: renderDoctorStatsTab }
            };
            
            /**
             * Renders the doctor's profile tab.
             * @param {HTMLElement} container - The container element for the tab.
             * @param {Object} user - Firebase User object.
             * @param {Object} userData - Doctor's custom user data.
             */
            function renderDoctorProfileTab(container, user, userData) {
                 container.innerHTML = `
                    <div class="bg-white p-6 rounded-2xl shadow-lg max-w-lg mx-auto">
                        <h3 class="text-xl font-bold mb-6">Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ© Ù„Ù„Ø·Ø¨ÙŠØ¨</h3>
                        <form id="doctorProfileForm" class="space-y-4">
                            <input id="profileName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" class="w-full p-3 border rounded-lg" value="${userData.name || ''}" required>
                            <input id="profileSpecialty" placeholder="Ø§Ù„ØªØ®ØµØµ (Ù…Ø«Ø§Ù„: Ø·Ø¨ÙŠØ¨ Ø¹Ø§Ù…ØŒ Ø·Ø¨ÙŠØ¨ Ø£Ø·ÙØ§Ù„)" class="w-full p-3 border rounded-lg" value="${userData.specialty || ''}">
                            <button type="submit" id="saveDoctorProfileBtn" class="mt-2 w-full bg-teal-600 text-white font-bold py-3 rounded-lg hover:bg-teal-700">Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</button>
                        </form>
                    </div>
                `;

                container.querySelector('#doctorProfileForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const submitBtn = e.submitter;
                    showButtonLoading(submitBtn, true, 'Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª');

                    // SECURITY NOTE: Perform server-side validation and sanitization for all user inputs
                    // before saving to Firestore. This client-side validation is for basic UX.
                    const profileData = {
                        name: container.querySelector('#profileName').value,
                        specialty: container.querySelector('#profileSpecialty').value,
                    };
                    const userDocRef = doc(db, `/artifacts/${APP_ID}/users`, user.uid);
                    try {
                        await updateDoc(userDocRef, profileData);
                        showNotification("ØªÙ… Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­!");
                    } catch (error) {
                        console.error("Error saving doctor profile:", error);
                        showNotification("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨.", "error");
                    } finally {
                        showButtonLoading(submitBtn, false);
                    }
                });
            }
            
            /**
             * Renders the doctor's statistics tab.
             * @param {HTMLElement} container - The container element for the tab.
             * @param {Object} user - Firebase User object.
             * @param {Object} userData - Doctor's custom user data.
             */
            async function renderDoctorStatsTab(container, user, userData) {
                container.innerHTML = `
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <canvas id="doctorStatsChart"></canvas>
                    </div>
                `;

                const patientCount = userData.linkedPatients?.length || 0;
                let totalMeds = 0;
                let totalTakenDoses = 0;

                if (patientCount > 0) {
                    // Fetch medication counts and taken doses for all linked patients
                    const patientMedsPromises = userData.linkedPatients.map(async (patientId) => {
                        const medsRef = collection(db, `/artifacts/${APP_ID}/users/${patientId}/medications`);
                        const medsSnapshot = await getDocs(medsRef);
                        let patientMedsAddedByDoctor = 0;
                        let patientTakenDoses = 0;
                        medsSnapshot.forEach(docSnap => {
                            const med = docSnap.data();
                            if (med.addedBy === 'doctor') {
                                patientMedsAddedByDoctor++;
                            }
                            patientTakenDoses += med.takenDates?.length || 0;
                        });
                        return { medsAddedByDoctor: patientMedsAddedByDoctor, takenDoses: patientTakenDoses };
                    });
                    const patientStats = await Promise.all(patientMedsPromises);
                    totalMeds = patientStats.reduce((sum, stats) => sum + stats.medsAddedByDoctor, 0);
                    totalTakenDoses = patientStats.reduce((sum, stats) => sum + stats.takenDoses, 0);
                }

                const ctx = document.getElementById('doctorStatsChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø§Ù„Ù…Ø±ØªØ¨Ø·ÙˆÙ†', 'Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ù…ÙˆØµÙˆÙØ©', 'Ø¬Ø±Ø¹Ø§Øª ØªÙ… Ø£Ø®Ø°Ù‡Ø§'],
                        datasets: [{
                            label: 'Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª',
                            data: [patientCount, totalMeds, totalTakenDoses],
                            backgroundColor: [
                                'rgba(13, 148, 136, 0.6)', // Teal
                                'rgba(59, 130, 246, 0.6)', // Blue
                                'rgba(251, 191, 36, 0.6)' // Yellow
                            ],
                            borderColor: [
                                'rgba(13, 148, 136, 1)',
                                'rgba(59, 130, 246, 1)',
                                'rgba(251, 191, 36, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }


            /**
             * Renders the doctor's linked patients tab.
             * @param {HTMLElement} container - The container element for the tab.
             * @param {Object} user - Firebase User object.
             * @param {Object} userData - Doctor's custom user data.
             */
            function renderDoctorPatientsTab(container, user, userData) {
                container.innerHTML = `
                    <div class="mb-4">
                        <input type="text" id="patient-search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø±ÙŠØ¶ Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù..." class="w-full p-3 border rounded-lg">
                    </div>
                    <div id="patients-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"><p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø¶Ù‰...</p></div>
                `;
                const listEl = container.querySelector('#patients-list');
                const searchInput = container.querySelector('#patient-search');

                let patientCards = []; // Cache for patient cards to facilitate searching

                const renderList = (filter = '') => {
                    listEl.innerHTML = '';
                    const lowerCaseFilter = filter.toLowerCase();
                    const filteredCards = patientCards.filter(card => 
                        card.name.toLowerCase().includes(lowerCaseFilter) ||
                        (card.fileNumber && card.fileNumber.toLowerCase().includes(lowerCaseFilter))
                    );

                    if (filteredCards.length === 0) {
                         listEl.innerHTML = `<p class="text-center text-gray-500 col-span-full">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø±Ø¶Ù‰ Ù…Ø·Ø§Ø¨Ù‚ÙˆÙ† Ù„Ù„Ø¨Ø­Ø«.</p>`;
                         return;
                    }
                    filteredCards.forEach(card => {
                        const item = document.createElement('div');
                        item.className = 'bg-white p-4 rounded-lg shadow-sm';
                        item.innerHTML = card.html;
                        listEl.appendChild(item);
                    });
                };

                searchInput.addEventListener('input', (e) => renderList(e.target.value));

                if (!userData.linkedPatients || userData.linkedPatients.length === 0) {
                    listEl.innerHTML = `<p class="text-center text-gray-500 col-span-full">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø¯ÙŠÙƒ Ù…Ø±Ø¶Ù‰ Ù…Ø±ØªØ¨Ø·ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹.</p>`;
                    return;
                }

                listEl.innerHTML = ''; // Clear initial loading message
                // Fetch details for each linked patient
                userData.linkedPatients.forEach(async (patientId) => {
                    const patientDocRef = doc(db, `/artifacts/${APP_ID}/users`, patientId);
                    const patientDoc = await getDoc(patientDocRef);
                    if (patientDoc.exists()) {
                        const patient = patientDoc.data();
                        patientCards.push({
                            name: patient.name || 'Ù…Ø±ÙŠØ¶ ØºÙŠØ± Ù…Ø³Ù…Ù‰',
                            fileNumber: patient.fileNumber || '',
                            html: `
                                <h4 class="font-bold text-lg">${patient.name || 'Ù…Ø±ÙŠØ¶ ØºÙŠØ± Ù…Ø³Ù…Ù‰'}</h4>
                                <p class="text-sm text-gray-600">Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù: ${patient.fileNumber || 'N/A'}</p>
                                <p class="text-sm text-gray-600">Ø§Ù„Ø¹Ù…Ø±: ${patient.age || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                                <div class="mt-4 flex gap-2">
                                     <button data-patient-id="${patientId}" data-patient-name="${patient.name || 'Ù…Ø±ÙŠØ¶'}" class="details-btn flex-1 bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600"><i class="fas fa-notes-medical mr-2"></i>Ø§Ù„ØªÙØ§ØµÙŠÙ„</button>
                                     <button data-patient-id="${patientId}" class="chat-btn flex-1 bg-teal-500 text-white py-2 rounded-lg hover:bg-teal-600"><i class="fas fa-comments mr-2"></i>Ù…Ø±Ø§Ø³Ù„Ø©</button>
                                </div>
                            `
                        });
                        renderList(searchInput.value); // Re-render list with new patient and current filter
                    }
                });

                // Event delegation for details and chat buttons
                listEl.addEventListener('click', (e) => {
                    const detailsBtn = e.target.closest('.details-btn');
                    const chatBtn = e.target.closest('.chat-btn');
                    if(detailsBtn) {
                        const { patientId, patientName } = detailsBtn.dataset;
                        showPatientDetailsModal(patientId, patientName);
                    }
                    if(chatBtn) {
                        const patientId = chatBtn.dataset.patientId;
                        renderChatModal(patientId, user.uid); // Patient's UID, Doctor's UID
                    }
                });
            }

            /**
             * Displays a modal with detailed information about a specific patient for the doctor.
             * @param {string} patientId - The UID of the patient.
             * @param {string} patientName - The name of the patient.
             */
            async function showPatientDetailsModal(patientId, patientName) {
                const modal = document.getElementById('doctorModal');
                const patientDoc = await getDoc(doc(db, `/artifacts/${APP_ID}/users`, patientId));
                const patientData = patientDoc.data();

                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h3 class="text-xl font-bold text-teal-700">ØªÙØ§ØµÙŠÙ„ ${patientName}</h3>
                                <p class="text-sm text-gray-500">UID: ${patientId}</p>
                            </div>
                            <button id="closeDoctorModal" class="text-2xl text-gray-500 hover:text-gray-800">&times;</button>
                        </div>

                        <div class="mb-4 p-4 bg-gray-100 rounded-lg">
                            <h4 class="font-bold mb-2">Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù</h4>
                            <div class="flex gap-2 items-center">
                                <input id="file-number-input" type="text" class="flex-grow p-2 border rounded-lg" value="${patientData.fileNumber || ''}" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù">
                                <button id="random-file-number-btn" class="p-2 bg-gray-200 rounded-lg hover:bg-gray-300" title="ØªÙˆÙ„ÙŠØ¯ Ø±Ù‚Ù… Ø¹Ø´ÙˆØ§Ø¦ÙŠ"><i class="fas fa-random"></i></button>
                                <button id="save-file-number-btn" class="p-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600" title="Ø­ÙØ¸ Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù"><i class="fas fa-save"></i></button>
                            </div>
                        </div>

                        <div class="mb-4">
                            <button id="add-med-btn" class="w-full bg-teal-600 text-white font-bold py-2 rounded-lg hover:bg-teal-700"><i class="fas fa-plus mr-2"></i>Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ§Ø¡ Ø¬Ø¯ÙŠØ¯</button>
                        </div>
                        <div id="patient-meds-list" class="text-gray-700 overflow-y-auto p-2 space-y-3">
                            <p class="text-center"><i class="fas fa-spinner fa-spin text-2xl"></i></p>
                        </div>
                    </div>
                `;
                modal.classList.add('active');
                cleanupListeners(); // Clean up listeners from previous modal instances

                // Event listener for clicking outside the modal content to close it
                modal.addEventListener('click', function handler(e) {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                        cleanupListeners(); // Ensure listeners are cleaned if closed by clicking outside
                        modal.removeEventListener('click', handler);
                    }
                });
                
                modal.querySelector('#closeDoctorModal').addEventListener('click', () => {
                    modal.classList.remove('active');
                    cleanupListeners(); // Clean up listeners when modal is closed
                });
                
                modal.querySelector('#add-med-btn').addEventListener('click', () => renderMedicationFormModal(patientId));
                
                modal.querySelector('#random-file-number-btn').addEventListener('click', () => {
                    modal.querySelector('#file-number-input').value = `F-${Math.floor(1000 + Math.random() * 9000)}`;
                });

                modal.querySelector('#save-file-number-btn').addEventListener('click', async (e) => {
                    const saveBtn = e.currentTarget;
                    showButtonLoading(saveBtn, true, '<i class="fas fa-save"></i>');
                    const fileNumber = modal.querySelector('#file-number-input').value;
                    // SECURITY NOTE: Perform server-side validation and sanitization for fileNumber
                    try {
                        await updateDoc(doc(db, `/artifacts/${APP_ID}/users`, patientId), { fileNumber });
                        showNotification("ØªÙ… Ø­ÙØ¸ Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­!");
                    } catch (error) {
                        console.error("Error saving file number:", error);
                        showNotification("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù.", "error");
                    } finally {
                        showButtonLoading(saveBtn, false);
                    }
                });

                const medsListEl = modal.querySelector('#patient-meds-list');
                // Listen for all medications (active and archived) for this patient
                const medsQuery = query(collection(db, `/artifacts/${APP_ID}/users/${patientId}/medications`), orderBy("createdAt", "desc"));
                
                const listener = onSnapshot(medsQuery, (snapshot) => {
                    medsListEl.innerHTML = '';
                    if (snapshot.empty) {
                        medsListEl.innerHTML = '<p class="text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¯ÙˆÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±ÙŠØ¶.</p>';
                        return;
                    }
                    snapshot.docs.forEach(docSnap => {
                        const med = docSnap.data();
                        const item = document.createElement('div');
                        // Add status class for visual distinction (e.g., archived meds might be faded)
                        const statusClass = med.status === 'archived' ? 'opacity-70' : '';
                        const createdAtDate = med.createdAt ? new Date(med.createdAt.toDate()).toLocaleDateString('ar-EG-u-nu-latn') : 'N/A';
                        item.className = `bg-gray-50 p-3 rounded-lg flex justify-between items-center ${statusClass}`;
                        item.innerHTML = `
                            <div>
                                <h4 class="font-bold">${med.name}</h4>
                                <p class="text-sm text-gray-600">${med.dosage} | ${med.times.join(', ')}</p>
                                <p class="text-xs text-gray-500">ØªØ¹Ù„ÙŠÙ…Ø§Øª: ${med.instructions || 'Ù„Ø§ ØªÙˆØ¬Ø¯'}</p>
                                <p class="text-xs text-gray-500">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©: ${createdAtDate}</p>
                                <p class="text-xs text-gray-500">ØªÙ… Ø£Ø®Ø° Ø§Ù„Ø¬Ø±Ø¹Ø§Øª: ${med.takenDates?.length || 0}</p>
                            </div>
                            <div class="flex gap-2">
                                <button data-med-id="${docSnap.id}" class="edit-med-btn text-blue-500 hover:text-blue-700" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ§Ø¡"><i class="fas fa-edit"></i></button>
                                <button data-med-id="${docSnap.id}" class="delete-med-btn text-red-500 hover:text-red-700" title="Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ§Ø¡"><i class="fas fa-trash"></i></button>
                            </div>
                        `;
                        medsListEl.appendChild(item);
                    });
                });
                activeListeners.push(listener); // Add listener to activeListeners array

                medsListEl.addEventListener('click', async (e) => {
                    const editBtn = e.target.closest('.edit-med-btn');
                    const deleteBtn = e.target.closest('.delete-med-btn');

                    if (editBtn) {
                        const medId = editBtn.dataset.medId; // Corrected from med-id
                        const medRef = doc(db, `/artifacts/${APP_ID}/users/${patientId}/medications`, medId);
                        const medSnap = await getDoc(medRef);
                        if (medSnap.exists()) {
                            renderMedicationFormModal(patientId, medId, medSnap.data());
                        }
                    }

                    if (deleteBtn) {
                        const medId = deleteBtn.dataset.medId; // Corrected from med-id
                        renderConfirmationModal("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙˆØ§Ø¡ØŸ", async () => {
                            try {
                                await deleteDoc(doc(db, `/artifacts/${APP_ID}/users/${patientId}/medications`, medId));
                                showNotification("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ§Ø¡ Ø¨Ù†Ø¬Ø§Ø­.", "success");
                            } catch (error) {
                                console.error("Error deleting medication:", error);
                                showNotification("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ§Ø¡.", "error");
                            }
                        });
                    }
                });
            }
            
            /**
             * Renders a modal for adding or editing a medication for a patient (used by doctors).
             * @param {string} patientId - The UID of the patient.
             * @param {string|null} medId - The ID of the medication to edit, or null for new.
             * @param {Object} medData - Existing medication data if editing.
             */
            function renderMedicationFormModal(patientId, medId = null, medData = {}) {
                const isEditing = medId !== null;
                const modal = document.getElementById('medicationFormModal');
                const dosageOptions = ["1 Ø­Ø¨Ø©", "2 Ø­Ø¨Ø©", "Ù†ØµÙ Ø­Ø¨Ø©", "5 Ù…Ù„", "10 Ù…Ù„", "Ø¬Ø±Ø¹Ø© ÙˆØ§Ø­Ø¯Ø©"];
                const frequencyOptions = { 1: "Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙŠÙˆÙ…ÙŠØ§Ù‹", 2: "Ù…Ø±ØªÙŠÙ† ÙŠÙˆÙ…ÙŠØ§Ù‹", 3: "3 Ù…Ø±Ø§Øª ÙŠÙˆÙ…ÙŠØ§Ù‹", 4: "4 Ù…Ø±Ø§Øª ÙŠÙˆÙ…ÙŠØ§Ù‹"};

                // Pre-fill times for editing
                const initialTimes = medData.times || [];
                const initialFrequency = initialTimes.length > 0 ? initialTimes.length.toString() : '';

                modal.innerHTML = `
                    <div class="modal-content">
                        <h3 class="text-xl font-bold mb-6">${isEditing ? 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ§Ø¡' : 'Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ§Ø¡ Ø¬Ø¯ÙŠØ¯'}</h3>
                        <form id="doctorMedForm" class="space-y-4">
                            <input id="docMedName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡" class="w-full p-3 border rounded-lg" value="${medData.name || ''}" required>
                            <select id="docMedDosage" class="w-full p-3 border rounded-lg">${dosageOptions.map(o => `<option value="${o}" ${medData.dosage === o ? 'selected' : ''}>${o}</option>`).join('')}</select>
                            
                            <select id="docMedFrequency" class="w-full p-3 border rounded-lg"><option value="">ÙƒÙ… Ù…Ø±Ø© ÙÙŠ Ø§Ù„ÙŠÙˆÙ…ØŸ</option>${Object.entries(frequencyOptions).map(([val, text]) => `<option value="${val}" ${initialFrequency === val ? 'selected' : ''}>${text}</option>`).join('')}</select>
                            <div id="docMedTimesContainer" class="grid grid-cols-2 md:grid-cols-4 gap-4 ${initialFrequency ? '' : 'hidden'}"></div>

                            <textarea id="docMedInstructions" placeholder="ØªØ¹Ù„ÙŠÙ…Ø§Øª ÙˆØªØ­Ø°ÙŠØ±Ø§Øª" class="w-full p-3 border rounded-lg h-24">${medData.instructions || ''}</textarea>
                            <div class="flex gap-4 mt-4">
                                <button type="button" id="cancelMedForm" class="flex-1 bg-gray-300 text-gray-800 font-bold py-3 rounded-lg hover:bg-gray-400">Ø¥Ù„ØºØ§Ø¡</button>
                                <button type="submit" id="submitMedFormBtn" class="flex-1 bg-teal-600 text-white font-bold py-3 rounded-lg hover:bg-teal-700">${isEditing ? 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª' : 'Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆØ§Ø¡'}</button>
                            </div>
                        </form>
                    </div>
                `;
                modal.classList.add('active');

                // Event listener for clicking outside the modal content to close it
                modal.addEventListener('click', function handler(e) {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                        modal.removeEventListener('click', handler);
                    }
                });

                const docMedFrequencySelect = modal.querySelector('#docMedFrequency');
                const docMedTimesContainer = modal.querySelector('#docMedTimesContainer');

                // Function to render time inputs based on frequency
                const renderTimeInputs = (count, existingTimes = []) => {
                    docMedTimesContainer.innerHTML = '';
                    const timePresets = [{icon:'â˜€ï¸', label:'ØµØ¨Ø§Ø­Ø§Ù‹'}, {icon:'ğŸ•›', label:'Ø¸Ù‡Ø±Ø§Ù‹'}, {icon:'ï¿½', label:'Ù…Ø³Ø§Ø¡Ù‹'}, {icon:'ğŸ›Œ', label:'Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…'}];
                    if (count > 0) {
                        docMedTimesContainer.classList.remove('hidden');
                        for (let i = 0; i < count; i++) {
                            const preset = timePresets[i] || {icon: 'â°', label: `Ø§Ù„ÙˆÙ‚Øª ${i+1}`};
                            const timeValue = existingTimes[i] || '';
                            docMedTimesContainer.innerHTML += `<div class="flex items-center gap-2"><label class="w-28">${preset.icon} ${preset.label}</label><input type="time" class="doc-med-time-input flex-1 p-2 border rounded-lg" value="${timeValue}" required></div>`;
                        }
                    } else {
                        docMedTimesContainer.classList.add('hidden');
                    }
                };

                // Initial render of time inputs if editing an existing medication
                if (isEditing && initialTimes.length > 0) {
                    renderTimeInputs(initialTimes.length, initialTimes);
                }

                // Event listener for frequency select to dynamically generate time inputs
                docMedFrequencySelect.addEventListener('change', (e) => {
                    const count = parseInt(e.target.value, 10);
                    renderTimeInputs(count); // Pass empty array for new selection
                });

                modal.querySelector('#cancelMedForm').addEventListener('click', () => modal.classList.remove('active'));

                modal.querySelector('#doctorMedForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const submitBtn = e.submitter;
                    showButtonLoading(submitBtn, true, isEditing ? 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª' : 'Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆØ§Ø¡');

                    // SECURITY NOTE: Perform server-side validation and sanitization for all user inputs
                    // before saving to Firestore. This client-side validation is for basic UX.
                    const updatedMedData = {
                        name: modal.querySelector('#docMedName').value,
                        dosage: modal.querySelector('#docMedDosage').value,
                        instructions: modal.querySelector('#docMedInstructions').value,
                        times: Array.from(modal.querySelectorAll('.doc-med-time-input')).map(input => input.value),
                        addedBy: 'doctor',
                        status: 'active', // Ensure status is set
                        ...(isEditing ? {} : { createdAt: serverTimestamp(), takenDates: [] }) // Only set createdAt and takenDates for new meds
                    };

                    const collectionRef = collection(db, `/artifacts/${APP_ID}/users/${patientId}/medications`);
                    try {
                        if (isEditing) {
                            await updateDoc(doc(collectionRef, medId), updatedMedData);
                            showNotification("ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ§Ø¡ Ø¨Ù†Ø¬Ø§Ø­!");
                        } else {
                            await addDoc(collectionRef, updatedMedData);
                            showNotification("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆØ§Ø¡ Ø¨Ù†Ø¬Ø§Ø­!");
                        }
                        modal.classList.remove('active');
                    } catch (error) {
                        console.error("Error saving medication:", error);
                        showNotification("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¯ÙˆØ§Ø¡.", "error");
                    } finally {
                        showButtonLoading(submitBtn, false);
                    }
                });
            }


            /**
             * Renders the doctor's "Add Patient" tab for sending connection requests.
             * @param {HTMLElement} container - The container element for the tab.
             * @param {Object} user - Firebase User object.
             */
            function renderDoctorAddPatientTab(container, user) {
                container.innerHTML = `
                    <div class="bg-white p-6 rounded-2xl shadow-lg max-w-lg mx-auto">
                        <h3 class="text-xl font-bold mb-4">Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø±Ø¨Ø· Ù„Ù…Ø±ÙŠØ¶</h3>
                        <p class="text-gray-600 mb-4">Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø±ÙŠØ¶ (UID) Ù„Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ù…ØªØ§Ø¨Ø¹Ø©.</p>
                        <form id="addPatientForm" class="flex flex-col sm:flex-row gap-2">
                            <input id="patientCodeInput" placeholder="Ø±Ù…Ø² Ø§Ù„Ù…Ø±ÙŠØ¶" class="flex-grow p-3 border rounded-lg" required>
                            <button type="submit" id="sendRequestBtn" class="bg-teal-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-teal-700">Ø¥Ø±Ø³Ø§Ù„</button>
                        </form>
                    </div>`;
                
                container.querySelector('#addPatientForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const submitBtn = e.submitter;
                    showButtonLoading(submitBtn, true, 'Ø¥Ø±Ø³Ø§Ù„');

                    const patientId = container.querySelector('#patientCodeInput').value.trim();
                    
                    if (patientId === user.uid) {
                        showNotification("Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù†ÙØ³Ùƒ.", "error");
                        showButtonLoading(submitBtn, false);
                        return;
                    }

                    try {
                        const patientDoc = await getDoc(doc(db, `/artifacts/${APP_ID}/users`, patientId));
                        if (!patientDoc.exists() || patientDoc.data().role !== 'patient') {
                            showNotification("Ø±Ù…Ø² Ø§Ù„Ù…Ø±ÙŠØ¶ ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.", "error");
                            showButtonLoading(submitBtn, false);
                            return;
                        }

                        // Check if a pending request already exists
                        const existingRequestsQuery = query(
                            collection(db, `/artifacts/${APP_ID}/public/data/connectionRequests`),
                            where("from", "==", user.uid),
                            where("to", "==", patientId),
                            where("status", "==", "pending")
                        );
                        const existingRequestsSnapshot = await getDocs(existingRequestsQuery);
                        if (!existingRequestsSnapshot.empty) {
                            showNotification("Ù„Ù‚Ø¯ Ø£Ø±Ø³Ù„Øª Ø·Ù„Ø¨Ù‹Ø§ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±ÙŠØ¶ Ø¨Ø§Ù„ÙØ¹Ù„ ÙˆÙ‡Ùˆ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±.", "error");
                            showButtonLoading(submitBtn, false);
                            return;
                        }

                        const requestRef = collection(db, `/artifacts/${APP_ID}/public/data/connectionRequests`);
                        await addDoc(requestRef, {
                            from: user.uid,
                            to: patientId,
                            status: "pending",
                            createdAt: serverTimestamp()
                        });
                        showNotification("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!");
                        e.target.reset(); // Reset the form
                    } catch (error) {
                        console.error("Error sending connection request:", error);
                        showNotification("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨.", "error");
                    } finally {
                        showButtonLoading(submitBtn, false);
                    }
                });
            }
            
            // --- 8. CHAT & NOTIFICATIONS ---

            /**
             * Sets up a real-time listener for chat notifications for a doctor.
             * @param {string} doctorId - The UID of the doctor.
             */
            function setupDoctorNotificationListeners(doctorId) {
                const chatsRef = collection(db, `/artifacts/${APP_ID}/public/data/chats`);
                // Query for chats where the doctor is a participant
                const q = query(chatsRef, where("participants", "array-contains", doctorId));

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        // Only notify for new messages or modified messages (e.g., status change)
                        if (change.type === "modified" || change.type === "added") {
                            const chatData = change.doc.data();
                            // Check if the last message is new and not from the doctor themselves
                            if (chatData.lastMessage && chatData.lastMessage.senderId !== doctorId) {
                                 if(chatData.lastMessage.status === 'urgent' || chatData.lastMessage.status === 'emergency') {
                                    showNotification(`Ø±Ø³Ø§Ù„Ø© ${chatData.lastMessage.status === 'urgent' ? 'Ø¹Ø§Ø¬Ù„Ø©' : 'Ø·Ø§Ø±Ø¦Ø©'} Ù…Ù† Ù…Ø±ÙŠØ¶!`, 'error');
                                 } else if (chatData.lastMessage.status === 'normal' && change.type === "added") {
                                     // Basic notification for new normal messages
                                     showNotification("Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ù…Ø±ÙŠØ¶.", "success");
                                 }
                            }
                        }
                    });
                });
                activeListeners.push(unsubscribe); // Add listener to activeListeners array
            }


            /**
             * Renders the chat modal for communication between a patient and a doctor.
             * @param {string} patientId - The UID of the patient.
             * @param {string} doctorId - The UID of the doctor.
             */
            async function renderChatModal(patientId, doctorId) {
                const modal = document.getElementById('chatModal');
                const currentUser = auth.currentUser;
                const currentUserDoc = await getDoc(doc(db, `/artifacts/${APP_ID}/users`, currentUser.uid));
                const isDoctor = currentUserDoc.data().role === 'doctor';
                
                const otherUserId = isDoctor ? patientId : doctorId;
                const otherUserDoc = await getDoc(doc(db, `/artifacts/${APP_ID}/users`, otherUserId));
                const otherUserName = otherUserDoc.data().name || 'Ù…Ø³ØªØ®Ø¯Ù…';
                
                // Create a consistent chat ID by sorting participant UIDs
                const chatId = [patientId, doctorId].sort().join('_');
                const chatDocRef = doc(db, `/artifacts/${APP_ID}/public/data/chats`, chatId);
                const messagesRef = collection(chatDocRef, 'messages');

                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="flex justify-between items-center mb-4 border-b pb-3">
                            <h3 class="text-xl font-bold text-teal-700">Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ ${otherUserName}</h3>
                            <button id="closeChatModal" class="text-2xl text-gray-500 hover:text-gray-800">&times;</button>
                        </div>
                        <div id="chat-messages" class="flex-grow overflow-y-auto p-2 flex flex-col gap-3 mb-4">
                            <!-- Messages will be rendered here -->
                        </div>
                        <form id="chat-form" class="flex gap-2 items-center">
                            <input type="file" id="file-input" class="hidden">
                            <button type="button" id="attach-file-btn" class="p-3 bg-gray-200 rounded-lg hover:bg-gray-300" title="Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ù"><i class="fas fa-paperclip"></i></button>
                            <input id="chat-input" class="flex-grow p-3 border rounded-lg" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." required>
                            <select id="chat-status" class="border rounded-lg p-2 ${isDoctor ? 'hidden' : ''}">
                                <option value="normal" class="text-green-600">Ø¹Ø§Ø¯ÙŠØ©</option>
                                <option value="urgent" class="text-yellow-600">Ø¹Ø§Ø¬Ù„Ø©</option>
                                <option value="emergency" class="text-red-600">Ø·Ø§Ø±Ø¦Ø©</option>
                            </select>
                            <button type="submit" id="sendMessageBtn" class="bg-teal-600 text-white font-bold p-3 rounded-lg hover:bg-teal-700" title="Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©"><i class="fas fa-paper-plane"></i></button>
                        </form>
                    </div>
                `;
                modal.classList.add('active');
                cleanupListeners(); // Clean up listeners from previous modal instances

                // Event listener for clicking outside the modal content to close it
                modal.addEventListener('click', function handler(e) {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                        cleanupListeners(); // Ensure listeners are cleaned if closed by clicking outside
                        modal.removeEventListener('click', handler);
                    }
                });

                const messagesContainer = modal.querySelector('#chat-messages');
                const fileInput = modal.querySelector('#file-input');
                let lastDate = null; // To group messages by date

                // Query messages ordered by timestamp
                const q = query(messagesRef, orderBy("timestamp"));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    messagesContainer.innerHTML = ''; // Clear previous messages
                    lastDate = null; // Reset lastDate on full re-render
                    snapshot.forEach((doc) => {
                        const message = doc.data();
                        const messageDate = message.timestamp?.toDate().toLocaleDateString();

                        // Add date separator if date changes
                        if (messageDate !== lastDate) {
                            const dateEl = document.createElement('div');
                            dateEl.className = 'date-separator';
                            dateEl.textContent = new Date(message.timestamp?.toDate()).toLocaleDateString('ar-EG-u-nu-latn', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                            messagesContainer.appendChild(dateEl);
                            lastDate = messageDate;
                        }

                        const messageEl = document.createElement('div');
                        const isSent = message.senderId === currentUser.uid;
                        messageEl.className = `chat-bubble ${isSent ? 'chat-sent' : 'chat-received'}`;
                        
                        if (message.type === 'file') {
                            // SECURITY NOTE: Sanitize file names and URLs before displaying to prevent XSS.
                            // Ensure fileURL is a valid and expected URL.
                            const safeFileName = DOMPurify.sanitize(message.fileName); // Example using DOMPurify
                            const safeFileURL = DOMPurify.sanitize(message.fileURL); // Example using DOMPurify
                            messageEl.innerHTML = `
                                <a href="${safeFileURL}" target="_blank" class="flex items-center gap-2 underline">
                                    <i class="fas fa-file-alt"></i>
                                    <span>${safeFileName}</span>
                                </a>
                            `;
                        } else {
                            // SECURITY NOTE: Sanitize message text to prevent XSS attacks.
                            // For example, if users can type HTML, it should be escaped or sanitized.
                            const sanitizedText = DOMPurify.sanitize(message.text); // Example using DOMPurify
                            // Display status badge for urgent/emergency messages
                            const statusBadge = `<span class="status-badge status-${message.status} mr-2">${message.status === 'urgent' ? 'Ø¹Ø§Ø¬Ù„Ø©' : message.status === 'emergency' ? 'Ø·Ø§Ø±Ø¦Ø©' : ''}</span>`;
                            messageEl.innerHTML = `
                                <p>${sanitizedText}</p>
                                <div class="text-xs mt-1 opacity-75 flex justify-end items-center">
                                    ${message.status !== 'normal' ? statusBadge : ''}
                                    ${new Date(message.timestamp?.toDate()).toLocaleTimeString('ar-EG-u-nu-latn', { hour: '2-digit', minute: '2-digit' })}
                                </div>
                            `;
                        }
                        messagesContainer.appendChild(messageEl);
                    });
                    messagesContainer.scrollTop = messagesContainer.scrollHeight; // Scroll to bottom
                });
                activeListeners.push(unsubscribe); // Add listener to activeListeners array

                modal.querySelector('#closeChatModal').addEventListener('click', () => {
                    modal.classList.remove('active');
                    unsubscribe(); // Unsubscribe from chat messages when modal is closed
                });
                
                modal.querySelector('#attach-file-btn').addEventListener('click', () => fileInput.click());
                
                fileInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    showLoading(true); // Show global loading for file upload
                    try {
                        const storageRef = ref(storage, `chat_files/${chatId}/${Date.now()}_${file.name}`);
                        await uploadBytes(storageRef, file);
                        const downloadURL = await getDownloadURL(storageRef);
                        
                        // SECURITY NOTE: File uploads should also be validated on the server-side
                        // (e.g., file type, size) to prevent malicious uploads.
                        const messageData = {
                            type: 'file',
                            fileName: file.name,
                            fileURL: downloadURL,
                            senderId: currentUser.uid,
                            status: 'normal', // Files are usually normal status
                            timestamp: serverTimestamp()
                        };
                        await addDoc(messagesRef, messageData);

                        // Update the main chat document with the last message for notifications
                        await setDoc(chatDocRef, { 
                            lastMessage: messageData,
                            participants: [patientId, doctorId] // Ensure participants array exists
                        }, { merge: true }); // Use merge to avoid overwriting other fields

                    } catch (error) {
                        console.error("File upload error:", error);
                        showNotification("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù.", "error");
                    } finally {
                        showLoading(false);
                        e.target.value = ''; // Clear file input
                    }
                });


                modal.querySelector('#chat-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const input = modal.querySelector('#chat-input');
                    const statusSelect = modal.querySelector('#chat-status');
                    const sendMessageBtn = modal.querySelector('#sendMessageBtn');
                    showButtonLoading(sendMessageBtn, true, '<i class="fas fa-paper-plane"></i>');

                    const text = input.value.trim();
                    if (text) {
                        // SECURITY NOTE: Sanitize message text on the server-side before saving to Firestore
                        // to prevent XSS attacks.
                        const messageData = {
                            type: 'text',
                            text: text,
                            senderId: currentUser.uid,
                            status: isDoctor ? 'normal' : statusSelect.value, // Doctors always send normal messages
                            timestamp: serverTimestamp()
                        };
                        try {
                            await addDoc(messagesRef, messageData);
                            
                            // Update the main chat document with the last message for notifications
                            await setDoc(chatDocRef, { 
                                lastMessage: messageData,
                                participants: [patientId, doctorId]
                            }, { merge: true });

                            input.value = ''; // Clear input field
                        } catch (error) {
                            console.error("Error sending message:", error);
                            showNotification("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©.", "error");
                        } finally {
                            showButtonLoading(sendMessageBtn, false);
                        }
                    } else {
                        showButtonLoading(sendMessageBtn, false);
                    }
                });
            }


            // --- 9. AI, RATING & 2FA MODALS ---

            /**
             * Displays a modal with AI-generated information about a medication.
             * @param {string} medName - The name of the medication to explain.
             */
            async function explainMedWithAI(medName) {
                const modal = document.getElementById('aiModal');
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-sky-700"><i class="fas fa-robot mr-2"></i>Ø´Ø±Ø­ Ø§Ù„Ø¯ÙˆØ§Ø¡ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h3>
                            <button id="closeAiModalBtn" class="text-2xl text-gray-500 hover:text-gray-800">&times;</button>
                        </div>
                        <div id="aiModalContent" class="text-gray-700 max-h-80 overflow-y-auto p-2">
                             <p class="text-center"><i class="fas fa-spinner fa-spin text-2xl"></i> Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª...</p>
                        </div>
                    </div>
                `;
                modal.classList.add('active');

                // Event listener for clicking outside the modal content to close it
                modal.addEventListener('click', function handler(e) {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                        modal.removeEventListener('click', handler);
                    }
                });

                modal.querySelector('#closeAiModalBtn').addEventListener('click', () => modal.classList.remove('active'));

                const contentEl = modal.querySelector('#aiModalContent');
                const prompt = `Ø¨ØµÙØªÙƒ Ù…Ø³Ø§Ø¹Ø¯ ØµÙŠØ¯Ù„ÙŠØŒ Ø§Ø´Ø±Ø­ Ø¯ÙˆØ§Ø¡ "${medName}" Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ù…Ø¨Ø³Ø·Ø©. Ù…Ø§ Ù‡ÙŠ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ø§ØªÙ‡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆÙ…Ø§ Ù‡ÙŠ Ø£Ù‡Ù… Ø§Ù„Ù†ØµØ§Ø¦Ø­ Ø§Ù„Ø¹Ø§Ù…Ø© Ù„ØªÙ†Ø§ÙˆÙ„Ù‡ØŸ Ø§Ø¬Ø¹Ù„ Ø§Ù„Ø´Ø±Ø­ Ù‚ØµÙŠØ±Ø§Ù‹ ÙˆÙˆØ§Ø¶Ø­Ø§Ù‹.`;
                
                // SECURITY IMPROVEMENT: Instead of direct API call, call a secure backend endpoint.
                // This backend endpoint would then call the Gemini API using a securely stored key.
                // Example of how a backend call might look (assuming a Firebase Cloud Function):
                const backendEndpoint = 'YOUR_FIREBASE_CLOUD_FUNCTION_URL/explainMedication'; // Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø¨Ø¹Ù†ÙˆØ§Ù† URL Ù„ÙˆØ¸ÙŠÙØªÙƒ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©

                try {
                    const response = await fetch(backendEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            // SECURITY NOTE: If your backend requires authentication,
                            // pass the Firebase ID token here:
                            // 'Authorization': `Bearer ${await auth.currentUser.getIdToken()}`
                        },
                        body: JSON.stringify({ medName: medName, prompt: prompt })
                    });

                    if (!response.ok) {
                        // SECURITY NOTE: Avoid exposing backend error details to the client.
                        // Log full error on backend, send generic error to client.
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.explanation) { // Assuming your backend returns { explanation: "..." }
                        // SECURITY NOTE: Sanitize the AI-generated text before displaying it
                        // to prevent potential XSS if the AI output contains malicious HTML.
                        const sanitizedText = DOMPurify.sanitize(data.explanation); // ÙŠØªØ·Ù„Ø¨ ØªØ¶Ù…ÙŠÙ† Ù…ÙƒØªØ¨Ø© DOMPurify
                        contentEl.innerHTML = sanitizedText.replace(/\n/g, '<br>'); // Display newlines as breaks
                    } else {
                        throw new Error("Invalid response structure from backend.");
                    }

                } catch (error) {
                    console.error("AI Explanation Error:", error);
                    contentEl.innerHTML = `<p class="text-red-500">Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ù† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.</p>`;
                }
            }

            // SECURITY NOTE: To use DOMPurify, you would need to include it in your HTML:
            // <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.6/purify.min.js"></script>


            /**
             * Renders a modal for rating a doctor.
             * @param {string} doctorId - The UID of the doctor being rated.
             * @param {string} doctorName - The name of the doctor.
             */
            function renderRatingModal(doctorId, doctorName) {
                const modal = document.getElementById('ratingModal');
                let currentRating = 0; // Stores the selected rating

                modal.innerHTML = `
                    <div class="modal-content">
                        <h3 class="text-xl font-bold mb-4 text-center">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø·Ø¨ÙŠØ¨: ${doctorName}</h3>
                        <div class="rating-stars text-4xl text-center mb-6">
                            <i class="fas fa-star" data-value="1"></i>
                            <i class="fas fa-star" data-value="2"></i>
                            <i class="fas fa-star" data-value="3"></i>
                            <i class="fas fa-star" data-value="4"></i>
                            <i class="fas fa-star" data-value="5"></i>
                        </div>
                        <div class="flex gap-4">
                            <button id="cancel-rating" class="flex-1 bg-gray-300 text-gray-800 font-bold py-3 rounded-lg hover:bg-gray-400">Ø¥Ù„ØºØ§Ø¡</button>
                            <button id="submit-rating" class="flex-1 bg-yellow-500 text-white font-bold py-3 rounded-lg hover:bg-yellow-600" disabled>Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
                        </div>
                    </div>
                `;
                modal.classList.add('active');

                // Event listener for clicking outside the modal content to close it
                modal.addEventListener('click', function handler(e) {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                        modal.removeEventListener('click', handler);
                    }
                });

                const stars = modal.querySelectorAll('.rating-stars .fa-star');
                const submitBtn = modal.querySelector('#submit-rating');

                // Handle star hover effect
                stars.forEach(star => {
                    star.addEventListener('mouseover', (e) => {
                        stars.forEach(s => s.classList.remove('selected')); // Clear all selected
                        e.target.classList.add('selected'); // Select current
                        let prev = e.target.previousElementSibling;
                        while(prev) { // Select previous siblings
                            prev.classList.add('selected');
                            prev = prev.previousElementSibling;
                        }
                    });

                    // Handle star click to set rating
                    star.addEventListener('click', (e) => {
                        currentRating = parseInt(e.target.dataset.value);
                        submitBtn.disabled = false; // Enable submit button
                        stars.forEach(s => {
                            s.classList.toggle('selected', parseInt(s.dataset.value) <= currentRating);
                        });
                    });
                });
                
                // Reset stars to currentRating on mouse leave if no new rating is selected
                modal.querySelector('.rating-stars').addEventListener('mouseleave', () => {
                     stars.forEach(s => {
                        s.classList.toggle('selected', parseInt(s.dataset.value) <= currentRating);
                    });
                });

                modal.querySelector('#cancel-rating').addEventListener('click', () => modal.classList.remove('active'));
                
                submitBtn.addEventListener('click', async () => {
                    if (currentRating === 0) return; // Should be disabled if 0, but as a safeguard
                    showButtonLoading(submitBtn, true, 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…');

                    const doctorRef = doc(db, `/artifacts/${APP_ID}/users`, doctorId);
                    try {
                        // Use a transaction to safely update rating (prevents race conditions)
                        // SECURITY NOTE: Firestore security rules should also enforce that only
                        // authenticated users can submit ratings, and potentially limit
                        // one rating per patient per doctor.
                        await runTransaction(db, async (transaction) => {
                            const doctorDoc = await transaction.get(doctorRef);
                            if (!doctorDoc.exists()) {
                                throw "Doctor document does not exist!";
                            }
                            const oldRating = doctorDoc.data().rating || { total: 0, count: 0 };
                            const newCount = oldRating.count + 1;
                            const newTotal = oldRating.total + currentRating;
                            transaction.update(doctorRef, { 
                                rating: { total: newTotal, count: newCount }
                            });
                        });
                        showNotification("Ø´ÙƒØ±Ø§Ù‹ Ù„ØªÙ‚ÙŠÙŠÙ…Ùƒ!", "success");
                    } catch (error) {
                        console.error("Rating transaction failed: ", error);
                        showNotification("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ….", "error");
                    } finally {
                        showButtonLoading(submitBtn, false);
                        modal.classList.remove('active');
                    }
                });
            }
            
            /**
             * Renders a modal for setting up or deactivating 2-Factor Authentication (2FA).
             * @param {string} userId - The UID of the user.
             * @param {boolean} isEnabled - True if 2FA is currently enabled for the user.
             */
            function render2FASetupModal(userId, isEnabled) {
                const modal = document.getElementById('twoFactorAuthModal');
                modal.innerHTML = `
                    <div class="modal-content">
                        <h3 class="text-xl font-bold mb-4">Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø®Ø·ÙˆØªÙŠÙ†</h3>
                        ${isEnabled ? `
                            <p class="text-center mb-6">Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø®Ø·ÙˆØªÙŠÙ† Ù…ÙØ¹Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹. Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ¹Ø·ÙŠÙ„Ù‡ØŸ</p>
                            <div class="flex gap-4">
                                 <button id="cancel-2fa" class="flex-1 bg-gray-300 text-gray-800 font-bold py-3 rounded-lg hover:bg-gray-400">Ø¥Ù„ØºØ§Ø¡</button>
                                 <button id="deactivate-2fa" class="flex-1 bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700">ØªØ¹Ø·ÙŠÙ„</button>
                            </div>
                        ` : `
                            <p class="text-center text-gray-600 mb-4">Ø§Ù…Ø³Ø­ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù…Ø² Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ.</p>
                            <div id="qrcode" class="p-4 bg-white rounded-lg mb-4"></div>
                            <p class="text-center text-gray-600 mb-4">Ø«Ù… Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…ÙƒÙˆÙ† Ù…Ù† 6 Ø£Ø±Ù‚Ø§Ù… Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙŠØ²Ø©.</p>
                            <input id="2fa-code" type="number" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ù‡Ù†Ø§" class="w-full p-3 border rounded-lg mb-4 text-center tracking-[1rem]">
                            <div class="flex gap-4">
                                 <button id="cancel-2fa" class="flex-1 bg-gray-300 text-gray-800 font-bold py-3 rounded-lg hover:bg-gray-400">Ø¥Ù„ØºØ§Ø¡</button>
                                 <button id="activate-2fa" class="flex-1 bg-teal-600 text-white font-bold py-3 rounded-lg hover:bg-teal-700">ØªÙØ¹ÙŠÙ„</button>
                            </div>
                        `}
                    </div>
                `;
                modal.classList.add('active');

                // Event listener for clicking outside the modal content to close it
                modal.addEventListener('click', function handler(e) {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                        modal.removeEventListener('click', handler);
                    }
                });

                if (!isEnabled) {
                    // Generate QR code for TOTP (Time-based One-Time Password)
                    const qr = qrcode(0, 'M');
                    // The secret is simplified for demonstration; in real app, it should be a strong, unique secret
                    // SECURITY NOTE: In a real 2FA implementation, the secret should be generated securely on the server
                    // and stored encrypted. The client-side should only display the QR code.
                    qr.addData(`otpauth://totp/MedicationApp:${userId}?secret=${userId.substring(0,16)}&issuer=MedicationApp`);
                    qr.make();
                    modal.querySelector('#qrcode').innerHTML = qr.createImgTag(4);
                    
                    modal.querySelector('#activate-2fa').addEventListener('click', async (e) => {
                        const activateBtn = e.currentTarget;
                        showButtonLoading(activateBtn, true, 'ØªÙØ¹ÙŠÙ„');
                        // SECURITY NOTE: In a real app, you'd verify the 6-digit code using a library like 'otp-generator' on the backend.
                        // For this simulation, we just activate it. The code entered here is not actually verified.
                        try {
                            await updateDoc(doc(db, `/artifacts/${APP_ID}/users`, userId), { is2FAEnabled: true });
                            showNotification("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø®Ø·ÙˆØªÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­.", "success");
                            modal.classList.remove('active');
                            // Re-render profile tab to update button text and state
                            const userDoc = await getDoc(doc(db, `/artifacts/${APP_ID}/users`, userId));
                            renderPatientProfileTab(document.getElementById('tab-profile'), auth.currentUser, userDoc.data());
                        } catch (error) {
                            console.error("Error activating 2FA:", error);
                            showNotification("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø®Ø·ÙˆØªÙŠÙ†.", "error");
                        } finally {
                            showButtonLoading(activateBtn, false);
                        }
                    });
                } else {
                     modal.querySelector('#deactivate-2fa').addEventListener('click', async (e) => {
                        const deactivateBtn = e.currentTarget;
                        showButtonLoading(deactivateBtn, true, 'ØªØ¹Ø·ÙŠÙ„');
                        try {
                            await updateDoc(doc(db, `/artifacts/${APP_ID}/users`, userId), { is2FAEnabled: false });
                            showNotification("ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø®Ø·ÙˆØªÙŠÙ†.", "success");
                            modal.classList.remove('active');
                            const userDoc = await getDoc(doc(db, `/artifacts/${APP_ID}/users`, userId));
                            renderPatientProfileTab(document.getElementById('tab-profile'), auth.currentUser, userDoc.data());
                        } catch (error) {
                            console.error("Error deactivating 2FA:", error);
                            showNotification("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø®Ø·ÙˆØªÙŠÙ†.", "error");
                        } finally {
                            showButtonLoading(deactivateBtn, false);
                        }
                    });
                }

                modal.querySelector('#cancel-2fa').addEventListener('click', () => modal.classList.remove('active'));
            }

            // --- 10. INITIAL VIEWS & AUTH HANDLERS ---

            /**
             * Renders the initial home view where the user selects their role.
             */
            function renderHomeView() {
                views.home.innerHTML = `
                    <div class="min-h-screen flex flex-col items-center justify-center bg-teal-500 text-white p-4 text-center">
                        <i class="fas fa-pills text-6xl mb-4"></i>
                        <h1 class="text-5xl font-bold mb-2">Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø¯ÙˆØ§Ø¦ÙŠ Ø§Ù„Ø°ÙƒÙŠ</h1>
                        <p class="text-xl text-teal-100 mb-10 max-w-2xl">Ø§Ù„ØªØ²Ù… Ø¨Ø¹Ù„Ø§Ø¬Ùƒ Ø¨Ø³Ù‡ÙˆÙ„Ø©ØŒ ÙˆØ§Ø¨Ù‚ Ø¹Ù„Ù‰ ØªÙˆØ§ØµÙ„ Ø¯Ø§Ø¦Ù… Ù…Ø¹ Ø·Ø¨ÙŠØ¨Ùƒ.</p>
                        <div class="flex flex-col md:flex-row gap-4">
                            <button data-role="patient" class="role-selection-btn bg-white text-teal-600 font-bold py-3 px-8 rounded-full shadow-lg transform hover:scale-105 transition-transform">Ø£Ù†Ø§ Ù…Ø±ÙŠØ¶</button>
                            <button data-role="doctor" class="role-selection-btn border-2 border-white text-white font-bold py-3 px-8 rounded-full transform hover:scale-105 hover:bg-white hover:text-teal-600 transition-all">Ø£Ù†Ø§ Ø·Ø¨ÙŠØ¨</button>
                        </div>
                    </div>`;
                
                views.home.querySelectorAll('.role-selection-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        appState.currentAuthRole = btn.dataset.role; // Update global state
                        renderAuthView();
                        showView('auth');
                    });
                });
            }

            /**
             * Renders the authentication (login/signup) view.
             */
            function renderAuthView() {
                views.auth.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center p-4 bg-gray-100">
                        <div class="max-w-md w-full bg-white p-8 rounded-2xl shadow-lg">
                            <button class="back-to-home text-gray-500 hover:text-teal-600 mb-4"><i class="fas fa-arrow-right"></i> Ø¹ÙˆØ¯Ø©</button>
                            <h2 class="text-3xl font-bold text-center mb-2">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ</h2>
                            <p class="text-center text-teal-600 font-semibold mb-6">Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ€ <span id="roleText">${appState.currentAuthRole === 'patient' ? 'Ù…Ø±ÙŠØ¶' : 'Ø·Ø¨ÙŠØ¨'}</span></p>
                            <div id="authError" class="text-red-500 text-center mb-4 font-medium min-h-[2.5rem]"></div>
                            <form id="authForm" class="space-y-4">
                                <input type="email" id="emailInput" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" class="w-full px-4 py-3 border rounded-lg" required>
                                <input type="password" id="passwordInput" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="w-full px-4 py-3 border rounded-lg" required>
                            </form>
                            <div class="flex gap-4 mt-6">
                                <button id="loginButton" class="flex-1 bg-teal-600 text-white font-bold py-3 rounded-lg hover:bg-teal-700">Ø¯Ø®ÙˆÙ„</button>
                                <button id="signupButton" class="flex-1 bg-gray-200 text-teal-600 font-bold py-3 rounded-lg hover:bg-gray-300">ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
                            </div>
                            <div class="text-center mt-4">
                                <button id="goToResetPassword" class="text-sm text-teal-600 hover:underline">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ØŸ</button>
                            </div>
                        </div>
                    </div>`;
                
                views.auth.querySelector('.back-to-home').addEventListener('click', () => showView('home'));
                views.auth.querySelector('#goToResetPassword').addEventListener('click', () => {
                    renderResetPasswordView();
                    showView('resetPassword');
                });
                views.auth.querySelector('#signupButton').addEventListener('click', handleSignup);
                views.auth.querySelector('#loginButton').addEventListener('click', handleLogin);
            }

            /**
             * Renders the password reset view.
             */
            function renderResetPasswordView() {
                views.resetPassword.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center p-4 bg-gray-100">
                        <div class="max-w-md w-full bg-white p-8 rounded-2xl shadow-lg">
                            <button class="back-to-auth text-gray-500 hover:text-teal-600 mb-4"><i class="fas fa-arrow-right"></i> Ø¹ÙˆØ¯Ø©</button>
                            <h2 class="text-3xl font-bold text-center mb-2">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</h2>
                            <p id="resetMessage" class="text-center mb-4 font-medium min-h-[4rem] text-gray-600">Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§Ù„Ù…Ø³Ø¬Ù„ ÙˆØ³Ù†Ø±Ø³Ù„ Ù„Ùƒ Ø±Ø§Ø¨Ø·Ø§Ù‹ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†.</p>
                            <form id="resetForm">
                                <input type="email" id="resetEmailInput" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§Ù„Ù…Ø³Ø¬Ù„" class="w-full px-4 py-3 border rounded-lg" required>
                                <button type="submit" id="sendResetLinkBtn" class="mt-6 w-full bg-teal-600 text-white font-bold py-3 rounded-lg hover:bg-teal-700">Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø·</button>
                            </form>
                        </div>
                    </div>`;
                views.resetPassword.querySelector('.back-to-auth').addEventListener('click', () => showView('auth'));
                views.resetPassword.querySelector('#resetForm').addEventListener('submit', handlePasswordReset);
            }

            /**
             * Handles user signup.
             */
            async function handleSignup(e) {
                const email = views.auth.querySelector('#emailInput').value.trim();
                const password = views.auth.querySelector('#passwordInput').value.trim();
                const authErrorEl = views.auth.querySelector('#authError');
                const signupBtn = e.currentTarget;
                authErrorEl.textContent = '';

                // SECURITY NOTE: Client-side validation is for UX. Server-side validation
                // (e.g., Firebase Authentication's built-in checks) is crucial.
                if (!email || !password) { 
                    authErrorEl.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„.'; 
                    return; 
                }
                showButtonLoading(signupBtn, true, 'ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯');

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const userDocRef = doc(db, `/artifacts/${APP_ID}/users`, userCredential.user.uid);
                    await setDoc(userDocRef, {
                        email: userCredential.user.email,
                        role: appState.currentAuthRole, // Use current role from state
                        createdAt: serverTimestamp(),
                        linkedPatients: [],
                        linkedDoctors: []
                    });
                    // onAuthStateChanged will handle view transition
                } catch (error) {
                    showButtonLoading(signupBtn, false);
                    console.error("Signup Error:", error.code);
                    switch (error.code) {
                        case 'auth/email-already-in-use':
                            authErrorEl.textContent = 'Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„.';
                            break;
                        case 'auth/weak-password':
                            authErrorEl.textContent = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹. ÙŠØ¬Ø¨ Ø£Ù† ØªØªÙƒÙˆÙ† Ù…Ù† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.';
                            break;
                        case 'auth/invalid-email':
                            authErrorEl.textContent = 'ØµÙŠØºØ© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§Ù„Ø°ÙŠ Ø£Ø¯Ø®Ù„ØªÙ‡ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.';
                            break;
                        default:
                            authErrorEl.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„.';
                            break;
                    }
                }
            }

            /**
             * Handles user login.
             */
            async function handleLogin(e) {
                const email = views.auth.querySelector('#emailInput').value.trim();
                const password = views.auth.querySelector('#passwordInput').value.trim();
                const authErrorEl = views.auth.querySelector('#authError');
                const loginBtn = e.currentTarget;
                authErrorEl.textContent = '';

                // SECURITY NOTE: Client-side validation is for UX. Firebase Authentication
                // handles the actual credential validation securely on the server.
                if (!email || !password) { 
                    authErrorEl.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„.'; 
                    return; 
                }
                showButtonLoading(loginBtn, true, 'Ø¯Ø®ÙˆÙ„');

                try {
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    const userDocRef = doc(db, `/artifacts/${APP_ID}/users`, userCredential.user.uid);
                    const userDoc = await getDoc(userDocRef);
                    if (userDoc.exists() && userDoc.data().role !== appState.currentAuthRole) {
                        // If user tries to log in with the wrong role, sign out and show error
                        await signOut(auth);
                        showButtonLoading(loginBtn, false);
                        const wrongRole = userDoc.data().role === 'patient' ? 'Ù…Ø±ÙŠØ¶' : 'Ø·Ø¨ÙŠØ¨';
                        authErrorEl.textContent = `Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø³Ø¬Ù„ ÙƒÙ€ '${wrongRole}'. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø¹ÙˆØ¯Ø© ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆØ± Ø§Ù„ØµØ­ÙŠØ­.`;
                    }
                    // onAuthStateChanged will handle view transition if login is successful and role matches
                } catch (error) {
                    showButtonLoading(loginBtn, false);
                    console.error("Login Error:", error.code);
                    switch (error.code) {
                        case 'auth/user-not-found':
                        case 'auth/wrong-password':
                        case 'auth/invalid-credential':
                            authErrorEl.textContent = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.';
                            break;
                        case 'auth/invalid-email':
                            authErrorEl.textContent = 'ØµÙŠØºØ© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§Ù„Ø°ÙŠ Ø£Ø¯Ø®Ù„ØªÙ‡ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.';
                            break;
                        case 'auth/too-many-requests':
                            authErrorEl.textContent = 'ØªÙ… Ø­Ø¸Ø± Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø¤Ù‚ØªØ§Ù‹ Ø¨Ø³Ø¨Ø¨ ÙƒØ«Ø±Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ø§Ù‹.';
                            break;
                        default:
                            authErrorEl.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.';
                            break;
                    }
                }
            }

            /**
             * Handles sending a password reset email.
             * @param {Event} e - The form submit event.
             */
            async function handlePasswordReset(e) {
                e.preventDefault();
                const email = document.getElementById('resetEmailInput').value.trim();
                const messageEl = document.getElementById('resetMessage');
                const sendResetLinkBtn = document.getElementById('sendResetLinkBtn');

                if (!email) {
                    messageEl.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.';
                    messageEl.className = "text-red-500 text-center mb-4 font-medium min-h-[4rem]";
                    return;
                }
                showButtonLoading(sendResetLinkBtn, true, 'Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø·');

                try {
                    await sendPasswordResetEmail(auth, email);
                    messageEl.textContent = "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø¨Ù†Ø¬Ø§Ø­. Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªÙÙ‚Ø¯ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ÙˆØ§Ø±Ø¯.";
                    messageEl.className = "text-green-600 text-center mb-4 font-medium min-h-[4rem]";
                } catch (error) {
                    console.error("Password Reset Error:", error.code);
                    messageEl.textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³Ø¬Ù„.";
                    messageEl.className = "text-red-500 text-center mb-4 font-medium min-h-[4rem]";
                } finally {
                    showButtonLoading(sendResetLinkBtn, false);
                }
            }

            // --- 11. GLOBAL EVENT LISTENERS & APP START ---
            
            // Global logout button listener
            document.getElementById('logoutButton').addEventListener('click', () => signOut(auth));
            // Global theme toggle listener
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);

            // On initial load, check for saved theme preference and apply it
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);
            
            // Start the application by showing the home view
            renderHomeView();
            showView('home');
        }
    </script>
    <!-- SECURITY NOTE: Include DOMPurify library for sanitizing user-generated content -->
    <!-- This is crucial if you display any user-provided text or AI-generated text directly as HTML -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.6/purify.min.js"></script>
</body>
</html>