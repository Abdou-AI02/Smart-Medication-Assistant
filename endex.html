<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مساعدك الدوائي الذكي</title>
    
    <!-- Google Fonts (Cairo) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for Statistics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- jsPDF for Exporting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* Use the 'Cairo' font for the entire application */
        body { 
            font-family: 'Cairo', sans-serif; 
            background-color: #f8fafc; /* Light gray background */
            transition: background-color 0.3s, color 0.3s;
        }

        /* Dark Mode Styles */
        .dark, .dark body { background-color: #111827; color: #d1d5db; }
        .dark .bg-white { background-color: #1f2937; }
        .dark .bg-gray-50 { background-color: #374151; }
        .dark .bg-gray-100 { background-color: #374151; }
        .dark .bg-gray-200 { background-color: #4b5563; }
        .dark .text-gray-800 { color: #f9fafb; }
        .dark .text-gray-700 { color: #d1d5db; }
        .dark .text-gray-600 { color: #9ca3af; }
        .dark .text-gray-500 { color: #a1a1aa; }
        .dark .text-gray-400 { color: #d1d5db; }
        .dark .border-gray-200 { border-color: #374151; }
        .dark .border { border-color: #4b5563; }
        .dark .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.25); }
        .dark .chat-received { background-color: #374151; color: #f9fafb; }
        .dark .role-selection-btn.border-white { color: #f9fafb; border-color: #f9fafb; }
        .dark .role-selection-btn.border-white:hover { background-color: #f9fafb; color: #1f2937; }
        .dark #theme-toggle .fa-moon { display: none; }
        .dark #theme-toggle .fa-sun { display: inline-block; color: #facc15; }
        #theme-toggle .fa-sun { display: none; }


        /* Smooth transition for various properties */
        .smooth-transition { 
            transition: all 0.3s ease-in-out; 
        }

        /* Base styles for views, tabs, and modals (hidden by default) */
        .view, .tab-content, .modal { 
            display: none; 
        }

        /* Show active views, tabs, and modals */
        .view.active, .tab-content.active { 
            display: block; 
        }
        .modal.active { 
            display: flex; 
        }

        /* Styling for tab buttons */
        .tab-button { 
            padding: 0.75rem 1rem; 
            border-bottom: 3px solid transparent; 
            color: #4b5563; 
        }
        .dark .tab-button { color: #9ca3af; }


        /* Styling for the active tab button */
        .tab-button.active { 
            border-bottom-color: #0d9488; /* Teal border */
            color: #0d9488; /* Teal text color */
            font-weight: 700; 
        }
        .dark .tab-button.active { color: #2dd4bf; border-bottom-color: #2dd4bf; }


        /* QR Code image styling */
        #qrcode img { 
            margin: auto; 
            border: 4px solid white; 
            border-radius: 0.5rem; 
        }

        /* Modal container styling (the overlay) */
        .modal { 
            position: fixed; 
            inset: 0; 
            align-items: center; 
            justify-content: center; 
            background-color: rgba(0,0,0,0.5); /* Semi-transparent black background */
            z-index: 50; 
        }

        /* Modal content box styling */
        .modal-content { 
            background-color: white; 
            padding: 2rem; 
            border-radius: 1rem; 
            box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25); 
            max-width: 90%; 
            width: 600px; 
            display: flex; 
            flex-direction: column; 
            max-height: 90vh; /* Ensure modal doesn't exceed viewport height */
        }
        .dark .modal-content { background-color: #1f2937; }

        /* Badge for status indicators */
        .status-badge { 
            padding: 0.25rem 0.75rem; 
            border-radius: 9999px; 
            font-size: 0.75rem; 
            font-weight: bold; 
        }

        /* QR Code video scanner styling */
        #qr-video { 
            width: 100%; 
            height: auto; 
            border-radius: 0.5rem; 
        }

        /* Chat-specific styles */
        .chat-bubble {
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            max-width: 75%;
        }
        .chat-sent {
            background-color: #0d9488; /* Teal */
            color: white;
            border-bottom-right-radius: 0.25rem;
            align-self: flex-end;
        }
        .chat-received {
            background-color: #e5e7eb; /* Gray */
            color: #1f2937;
            border-bottom-left-radius: 0.25rem;
            align-self: flex-start;
        }
        .status-normal { background-color: #d1fae5; color: #065f46; }
        .status-urgent { background-color: #fef3c7; color: #92400e; }
        .status-emergency { background-color: #fee2e2; color: #991b1b; }
        .date-separator {
            text-align: center;
            color: #6b7280;
            font-size: 0.875rem;
            margin: 1rem 0;
        }
        .dark .date-separator { color: #9ca3af; }
        
        /* Rating Stars */
        .rating-stars .fa-star {
            cursor: pointer;
            color: #d1d5db; /* Gray stars by default */
            transition: color 0.2s;
        }
        .rating-stars .fa-star.selected,
        .rating-stars:hover .fa-star:hover,
        .rating-stars .fa-star:hover ~ .fa-star {
            color: #facc15; /* Yellow for selected/hovered */
        }
        .rating-stars:hover .fa-star {
             color: #facc15;
        }

        /* Loading spinner for buttons */
        .btn-loading {
            position: relative;
            pointer-events: none; /* Disable clicks during loading */
        }
        .btn-loading .spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 0.5rem; /* Space between spinner and text */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Notification Area -->
    <div id="notification" class="fixed top-0 left-1/2 -translate-x-1/2 w-full max-w-md p-4 rounded-b-lg shadow-lg text-white text-center z-[100] transition-transform duration-300 -translate-y-full">
        <p id="notification-message"></p>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-white bg-opacity-80 z-[100] flex-col justify-center items-center">
        <i class="fas fa-spinner fa-spin text-teal-500 text-4xl"></i>
        <p class="mt-4 text-lg text-gray-700">جاري التحميل...</p>
    </div>

    <!-- Main App Container -->
    <div id="app" class="min-h-screen">
        <!-- App Header (Visible when logged in) -->
        <header id="appHeader" class="hidden bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-40">
            <h1 class="text-2xl font-bold text-teal-600">مساعدك الدوائي</h1>
            <div class="flex items-center gap-4">
                <button id="theme-toggle" class="text-gray-500 hover:text-teal-600 text-xl">
                    <i class="fas fa-moon"></i>
                    <i class="fas fa-sun"></i>
                </button>
                <span id="userEmailDisplay" class="text-sm text-gray-600 hidden md:block"></span>
                <button id="logoutButton" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600">
                    <i class="fa-solid fa-right-from-bracket"></i>
                    <span class="hidden md:inline ml-2">خروج</span>
                </button>
            </div>
        </header>

        <!-- Main content area where views are rendered -->
        <main>
            <div id="homeView" class="view"></div>
            <div id="authView" class="view"></div>
            <div id="resetPasswordView" class="view"></div>
            <div id="patientDashboardView" class="view p-4 md:p-8"></div>
            <div id="doctorDashboardView" class="view p-4 md:p-8"></div>
        </main>
        
        <!-- Modals -->
        <div id="aiModal" class="modal"></div>
        <div id="doctorModal" class="modal"></div>
        <div id="medicationFormModal" class="modal"></div>
        <div id="chatModal" class="modal"></div>
        <div id="confirmationModal" class="modal"></div>
        <div id="policyModal" class="modal"></div>
        <div id="twoFactorAuthModal" class="modal"></div>
        <div id="ratingModal" class="modal"></div>

    </div>

    <!-- QR Code Generation Libraries -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    
    <!-- Main Application Logic -->
    <script type="module">
        // Import Firebase services at the top level of the module
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, query, onSnapshot, addDoc, where, writeBatch, serverTimestamp, getDocs, arrayUnion, deleteDoc, orderBy, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Check if the app is running from a local file
        if (window.location.protocol === 'file:') {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen flex flex-col items-center justify-center bg-red-100 text-red-800 p-8 text-center">
                    <i class="fas fa-exclamation-triangle text-5xl mb-4"></i>
                    <h1 class="text-3xl font-bold mb-2">خطأ في التشغيل</h1>
                    <p class="text-xl max-w-2xl">
                        لا يمكن تشغيل التطبيق مباشرة من ملف على جهازك. هذا يسبب مشاكل أمان (CORS) تمنع الاتصال بالخادم.
                    </p>
                    <p class="mt-4 text-lg font-semibold">الحل:</p>
                    <p class="text-lg max-w-2xl">
                        يجب تشغيل هذا الملف من خلال خادم ويب محلي. إذا كنت تستخدم محرر الأكواد Visual Studio Code، يمكنك تثبيت إضافة باسم "Live Server" وتشغيل التطبيق بها بسهولة.
                    </p>
                </div>
            `;
        } else {
            // --- NORMAL APP INITIALIZATION ---

            // --- 1. CONFIGURATION & INITIALIZATION ---
            
            // IMPORTANT SECURITY NOTE:
            // في بيئة الإنتاج، يجب ألا يتم عرض مفاتيح API الحساسة (مثل مفتاح Gemini API) مباشرةً في الكود جانب العميل.
            // يجب أن يتم تخزين هذه المفاتيح بشكل آمن على خادم خلفي (مثل Firebase Cloud Functions)
            // ويجب أن تتم جميع الطلبات التي تتطلب هذه المفاتيح عبر هذا الخادم الخلفي.
            // في هذا المثال، سنقوم بمحاكاة استدعاء خلفي لوظيفة الذكاء الاصطناعي.
            // const GEMINI_API_KEY = ""; // تم حذف هذا المتغير لأنه يجب أن يكون على الخادم الخلفي

            const firebaseConfig = {
                apiKey: "AIzaSyBxC0CPZzfoVviBM2UDEEamWwsJCw5cuqY", // هذا المفتاح ليس سريًا ولكنه يربط تطبيقك بمشروع Firebase
                authDomain: "my-app-9b541.firebaseapp.com",
                projectId: "my-app-9b541",
                storageBucket: "my-app-9b541.appspot.com",
                messagingSenderId: "895299955644",
                appId: "1:895299955644:web:e0a9a1d3f2b8c6d7e9f0b1"
            };

            // This APP_ID is used for Firestore collection paths to scope data to this specific application.
            // It's good practice for multi-app Firebase projects.
            const APP_ID = 'default-medication-app';

            // Initialize Firebase services
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const storage = getStorage(app);

            // --- 2. GLOBAL STATE & UI ELEMENTS ---
            let activeListeners = []; // Stores unsubscribe functions for Firestore listeners
            let appState = { // Centralized state object for easier management
                currentAuthRole: 'patient',
                currentUser: null,
                currentUserData: null
            };

            const loadingOverlay = document.getElementById('loading-overlay');
            const views = {
                home: document.getElementById('homeView'),
                auth: document.getElementById('authView'),
                resetPassword: document.getElementById('resetPasswordView'),
                patientDashboard: document.getElementById('patientDashboardView'),
                doctorDashboard: document.getElementById('doctorDashboardView'),
            };
            const appHeader = document.getElementById('appHeader');

            // --- 3. CORE UI HELPER FUNCTIONS ---

            /**
             * Shows or hides a global loading overlay.
             * @param {boolean} show - True to show, false to hide.
             */
            function showLoading(show) {
                loadingOverlay.classList.toggle('hidden', !show);
                loadingOverlay.classList.toggle('flex', show);
            }

            /**
             * Shows or hides a loading spinner on a specific button.
             * @param {HTMLElement} button - The button element.
             * @param {boolean} show - True to show spinner, false to hide.
             * @param {string} originalText - The original text of the button.
             */
            function showButtonLoading(button, show, originalText = '') {
                if (show) {
                    button.dataset.originalText = originalText || button.textContent;
                    button.innerHTML = '<span class="spinner"></span> جاري التحميل...';
                    button.classList.add('btn-loading');
                    button.disabled = true;
                } else {
                    button.innerHTML = button.dataset.originalText || '';
                    button.classList.remove('btn-loading');
                    button.disabled = false;
                }
            }

            /**
             * Activates a specific view and deactivates others.
             * @param {string} viewName - The ID of the view to activate.
             */
            function showView(viewName) {
                Object.values(views).forEach(v => v.classList.remove('active'));
                if (views[viewName]) {
                    views[viewName].classList.add('active');
                }
                // Hide header for auth/home/reset views
                appHeader.classList.toggle('hidden', ['home', 'auth', 'resetPassword'].includes(viewName));
                showLoading(false); // Hide global loading after view is rendered
            }

            /**
             * Displays a temporary notification message at the top of the screen.
             * @param {string} message - The message to display.
             * @param {'success'|'error'} type - The type of notification (determines color).
             */
            function showNotification(message, type = 'success') {
                const notification = document.getElementById('notification');
                const messageEl = document.getElementById('notification-message');

                messageEl.textContent = message;
                // Remove existing color classes and add the new one
                notification.className = notification.className.replace(/bg-\w+-\d+/, ''); 
                notification.classList.add(type === 'success' ? 'bg-teal-500' : 'bg-red-500');

                // Animate the notification into view
                notification.style.transform = 'translate(-50%, 0)';
                // Hide after 3 seconds
                setTimeout(() => {
                    notification.style.transform = 'translate(-50%, -100%)';
                }, 3000);
            }

            /**
             * Cleans up all active Firestore listeners to prevent memory leaks.
             */
            function cleanupListeners() {
                activeListeners.forEach(unsubscribe => unsubscribe());
                activeListeners = [];
            }
            
            /**
             * Renders a generic confirmation modal.
             * @param {string} message - The confirmation message.
             * @param {Function} onConfirm - Callback function to execute if confirmed.
             */
            function renderConfirmationModal(message, onConfirm) {
                const modal = document.getElementById('confirmationModal');
                modal.innerHTML = `
                    <div class="modal-content">
                        <p class="text-lg text-center mb-6">${message}</p>
                        <div class="flex gap-4">
                            <button id="confirm-btn" class="flex-1 bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700">تأكيد</button>
                            <button id="cancel-btn" class="flex-1 bg-gray-300 text-gray-800 font-bold py-3 rounded-lg hover:bg-gray-400">إلغاء</button>
                        </div>
                    </div>
                `;
                modal.classList.add('active');

                // Event listener for clicking outside the modal content to close it
                modal.addEventListener('click', function handler(e) {
                    if (e.target === modal) { // Only close if clicking on the overlay itself
                        modal.classList.remove('active');
                        modal.removeEventListener('click', handler); // Remove listener after use
                    }
                });

                modal.querySelector('#confirm-btn').addEventListener('click', () => {
                    onConfirm();
                    modal.classList.remove('active');
                });
                modal.querySelector('#cancel-btn').addEventListener('click', () => {
                    modal.classList.remove('active');
                });
            }
            
            // --- THEME/DARK MODE ---
            /**
             * Applies the specified theme to the document.
             * @param {'light'|'dark'} theme - The theme to apply.
             */
            function applyTheme(theme) {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }

            /**
             * Toggles between light and dark themes and saves preference to localStorage.
             */
            function toggleTheme() {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            }

            // --- 4. AUTHENTICATION & ROUTING ---

            /**
             * Listens for Firebase authentication state changes and updates UI accordingly.
             */
            onAuthStateChanged(auth, async (user) => {
                cleanupListeners(); // Clear all previous listeners on auth state change
                if (user && !user.isAnonymous) {
                    showLoading(true);
                    appState.currentUser = user;
                    const userDocRef = doc(db, `/artifacts/${APP_ID}/users`, user.uid);
                    try {
                        const userDoc = await getDoc(userDocRef);
                        if (userDoc.exists()) {
                            appState.currentUserData = userDoc.data();
                            document.getElementById('userEmailDisplay').textContent = user.email;
                            if (appState.currentUserData.role === 'patient') {
                                renderTabView(views.patientDashboard, patientTabs, 'meds', appState.currentUser, appState.currentUserData);
                                showView('patientDashboard');
                            } else if (appState.currentUserData.role === 'doctor') {
                                renderTabView(views.doctorDashboard, doctorTabs, 'patients', appState.currentUser, appState.currentUserData);
                                setupDoctorNotificationListeners(user.uid);
                                showView('doctorDashboard');
                            }
                        } else {
                            showNotification("بيانات المستخدم غير موجودة. يتم تسجيل الخروج.", "error");
                            await signOut(auth);
                        }
                    } catch (error) {
                        console.error("Auth state change error:", error);
                        showNotification("حدث خطأ. يتم تسجيل الخروج.", "error");
                        await signOut(auth);
                    }
                } else {
                    appState.currentUser = null;
                    appState.currentUserData = null;
                    renderHomeView();
                    showView('home');
                }
            });

            // --- 5. VIEW RENDERING ---

            /**
             * Renders a tabbed interface within a given container.
             * @param {HTMLElement} container - The HTML element to render tabs into.
             * @param {Object} tabsConfig - Configuration object for tabs.
             * @param {string} initialTab - The key of the tab to show initially.
             * @param {Object} user - Firebase User object.
             * @param {Object} userData - Custom user data from Firestore.
             */
            function renderTabView(container, tabsConfig, initialTab, user, userData) {
                const tabButtons = Object.keys(tabsConfig).map(key => 
                    `<button class="tab-button" data-tab="${key}">${tabsConfig[key].icon} ${tabsConfig[key].title}</button>`
                ).join('');

                container.innerHTML = `
                    <div class="border-b border-gray-200 mb-6">
                        <nav class="-mb-px flex flex-wrap gap-6" aria-label="Tabs">${tabButtons}</nav>
                    </div>
                    <div id="tab-content-container">
                        ${Object.keys(tabsConfig).map(key => `<div class="tab-content" id="tab-${key}"></div>`).join('')}
                    </div>
                `;

                const tabButtonElements = container.querySelectorAll('.tab-button');
                const tabContentElements = container.querySelectorAll('.tab-content');

                const switchTab = (tabKey) => {
                    tabButtonElements.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabKey));
                    tabContentElements.forEach(content => content.classList.toggle('active', content.id === `tab-${tabKey}`));
                    // Call the onRender function for the active tab
                    tabsConfig[tabKey].onRender(document.getElementById(`tab-${tabKey}`), user, userData);
                };

                container.querySelector('nav').addEventListener('click', (e) => {
                    const button = e.target.closest('.tab-button');
                    if (button) {
                        switchTab(button.dataset.tab);
                    }
                });

                // Set initial active tab
                switchTab(initialTab);
            }

            // --- 6. PATIENT DASHBOARD ---

            const patientTabs = {
                meds: { title: "أدويتي", icon: '<i class="fas fa-pills"></i>', onRender: renderPatientMedsTab },
                history: { title: "سجل الأدوية", icon: '<i class="fas fa-history"></i>', onRender: renderMedicationHistoryTab },
                myDoctors: { title: "أطبائي", icon: '<i class="fas fa-user-md"></i>', onRender: renderPatientDoctorsTab },
                profile: { title: "ملفي الشخصي", icon: '<i class="fas fa-user-edit"></i>', onRender: renderPatientProfileTab },
                requests: { title: "طلبات الربط", icon: '<i class="fas fa-user-friends"></i>', onRender: renderPatientRequestsTab },
            };

            /**
             * Renders the patient's current medications tab.
             * @param {HTMLElement} container - The container element for the tab.
             * @param {Object} user - Firebase User object.
             */
            function renderPatientMedsTab(container, user) {
                const dosageOptions = ["1 حبة", "2 حبة", "نصف حبة", "5 مل", "10 مل", "جرعة واحدة"];
                // Frequency options for dynamic time inputs
                const frequencyOptions = { 1: "مرة واحدة يومياً", 2: "مرتين يومياً", 3: "3 مرات يومياً", 4: "4 مرات يومياً"};

                container.innerHTML = `
                    <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
                        <h3 class="text-xl font-bold mb-6">إضافة دواء جديد</h3>
                        <form id="addMedForm" class="space-y-4">
                            <input id="medName" placeholder="اسم الدواء" class="w-full p-3 border rounded-lg" required>
                            <select id="medDosage" class="w-full p-3 border rounded-lg">${dosageOptions.map(o => `<option value="${o}">${o}</option>`).join('')}</select>
                            <select id="medFrequency" class="w-full p-3 border rounded-lg"><option value="">كم مرة في اليوم؟</option>${Object.entries(frequencyOptions).map(([val, text]) => `<option value="${val}">${text}</option>`).join('')}</select>
                            <div id="medTimesContainer" class="grid grid-cols-2 md:grid-cols-4 gap-4 hidden"></div>
                            <textarea id="medInstructions" placeholder="تعليمات وتحذيرات" class="w-full p-3 border rounded-lg h-24"></textarea>
                            <button type="submit" id="addMedSubmitBtn" class="w-full bg-teal-600 text-white font-bold py-3 rounded-lg hover:bg-teal-700">حفظ الدواء</button>
                        </form>
                    </div>
                    <div>
                         <div class="flex justify-between items-center mb-6">
                             <h3 class="text-xl font-bold">قائمة أدويتي الحالية</h3>
                             <button id="enable-reminders" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600"><i class="fas fa-bell mr-2"></i>تفعيل التنبيهات</button>
                         </div>
                        <div id="medicationsList" class="space-y-4"><p>جاري تحميل الأدوية...</p></div>
                    </div>`;
                
                container.querySelector('#enable-reminders').addEventListener('click', () => {
                    showNotification("سيتم تذكيرك بمواعيد دوائك (ميزة تجريبية).", "success");
                });
                
                const medFrequencySelect = container.querySelector('#medFrequency');
                const medTimesContainer = container.querySelector('#medTimesContainer');
                
                // Event listener for frequency select to dynamically generate time inputs
                medFrequencySelect.addEventListener('change', (e) => {
                    const count = parseInt(e.target.value, 10);
                    medTimesContainer.innerHTML = ''; // Clear previous inputs
                    const timePresets = [{icon:'☀️', label:'صباحاً'}, {icon:'🕛', label:'ظهراً'}, {icon:'🌙', label:'مساءً'}, {icon:'🛌', label:'قبل النوم'}];
                    if (count > 0) {
                        medTimesContainer.classList.remove('hidden');
                        for (let i = 0; i < count; i++) {
                            const preset = timePresets[i] || {icon: '⏰', label: `الوقت ${i+1}`};
                            medTimesContainer.innerHTML += `<div class="flex items-center gap-2"><label class="w-28">${preset.icon} ${preset.label}</label><input type="time" class="med-time-input flex-1 p-2 border rounded-lg" required></div>`;
                        }
                    } else {
                        medTimesContainer.classList.add('hidden');
                    }
                });

                // Handle form submission for adding new medication
                container.querySelector('#addMedForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const submitBtn = e.submitter; // The button that triggered the submit
                    showButtonLoading(submitBtn, true, 'حفظ الدواء');

                    // SECURITY NOTE: Perform server-side validation and sanitization for all user inputs
                    // before saving to Firestore. This client-side validation is for basic UX.
                    const medData = {
                        name: container.querySelector('#medName').value,
                        dosage: container.querySelector('#medDosage').value,
                        instructions: container.querySelector('#medInstructions').value,
                        times: Array.from(container.querySelectorAll('.med-time-input')).map(input => input.value),
                        createdAt: serverTimestamp(),
                        addedBy: 'patient',
                        status: 'active', // New field for active/archived medications
                        takenDates: [] // New field to track taken doses
                    };
                    
                    try {
                        const medRef = collection(db, `/artifacts/${APP_ID}/users/${user.uid}/medications`);
                        await addDoc(medRef, medData);
                        showNotification("تمت إضافة الدواء بنجاح!");
                        e.target.reset(); // Reset the form
                        medTimesContainer.classList.add('hidden'); // Hide time inputs after reset
                    } catch (error) {
                        console.error("Error adding medication:", error);
                        showNotification("حدث خطأ أثناء إضافة الدواء.", "error");
                    } finally {
                        showButtonLoading(submitBtn, false);
                    }
                });

                // Listen for real-time updates to the patient's active medications
                const medsQuery = query(collection(db, `/artifacts/${APP_ID}/users/${user.uid}/medications`), where("status", "==", "active"));
                const medsListener = onSnapshot(medsQuery, (snapshot) => {
                    const listEl = document.getElementById('medicationsList');
                    if(!listEl) return; // Ensure element exists before updating
                    listEl.innerHTML = '';
                    if(snapshot.empty) {
                        listEl.innerHTML = `<p class="text-center text-gray-500">لا توجد أدوية حالياً.</p>`;
                        return;
                    }
                    
                    snapshot.docs.forEach(docSnap => {
                        const med = docSnap.data();
                        const item = document.createElement('div');
                        item.className = 'bg-white p-4 rounded-lg shadow-sm';
                        // Display taken count and add "Mark as Taken" button
                        item.innerHTML = `<div class="flex justify-between items-start">
                                    <div>
                                        <h4 class="font-bold text-lg">${med.name}</h4>
                                        <p class="text-sm text-gray-600">${med.dosage} | ${med.times.join(', ')}</p>
                                        ${med.addedBy === 'doctor' ? '<p class="text-xs text-teal-600 font-bold mt-1">تمت إضافته بواسطة الطبيب</p>' : ''}
                                        <p class="text-xs text-gray-500 mt-1">تم أخذ الجرعات: ${med.takenDates?.length || 0}</p>
                                    </div>
                                    <div class="flex items-center gap-4">
                                        <button data-med-id="${docSnap.id}" class="mark-taken-btn text-green-500 hover:text-green-700" title="تم أخذ الجرعة"><i class="fas fa-check-circle text-xl"></i></button>
                                        <button data-med-id="${docSnap.id}" class="archive-med-btn text-gray-500 hover:text-red-600" title="أرشفة الدواء"><i class="fas fa-archive"></i></button>
                                        <button data-med-name="${med.name}" class="ai-info-btn text-sky-600 hover:text-sky-800" title="شرح بالذكاء الاصطناعي"><i class="fas fa-robot text-xl"></i></button>
                                    </div>
                                </div>`;
                        listEl.appendChild(item);
                    });

                    // Add event listeners for dynamically created buttons
                    listEl.querySelectorAll('.ai-info-btn').forEach(btn => btn.addEventListener('click', (e) => explainMedWithAI(e.currentTarget.dataset.medName)));
                    listEl.querySelectorAll('.archive-med-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                        const medId = e.currentTarget.dataset.medId;
                        try {
                            await updateDoc(doc(db, `/artifacts/${APP_ID}/users/${user.uid}/medications`, medId), { status: 'archived' });
                            showNotification("تمت أرشفة الدواء.", "success");
                        } catch (error) {
                            console.error("Error archiving medication:", error);
                            showNotification("حدث خطأ أثناء أرشفة الدواء.", "error");
                        }
                    }));
                    listEl.querySelectorAll('.mark-taken-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                        const medId = e.currentTarget.dataset.medId;
                        try {
                            await updateDoc(doc(db, `/artifacts/${APP_ID}/users/${user.uid}/medications`, medId), {
                                arrayUnion: arrayUnion(serverTimestamp()) // Add current timestamp to takenDates array
                            });
                            showNotification("تم تسجيل تناول الجرعة.", "success");
                        } catch (error) {
                            console.error("Error marking medication as taken:", error);
                            showNotification("حدث خطأ أثناء تسجيل الجرعة.", "error");
                        }
                    }));
                });
                activeListeners.push(medsListener); // Add listener to activeListeners array for cleanup
            }

            /**
             * Renders the patient's medication history tab (archived medications).
             * @param {HTMLElement} container - The container element for the tab.
             * @param {Object} user - Firebase User object.
             */
            function renderMedicationHistoryTab(container, user) {
                container.innerHTML = `<div id="med-history-list" class="space-y-4"><p>جاري تحميل السجل...</p></div>`;
                const listEl = container.querySelector('#med-history-list');
                // Query for archived medications
                const medsQuery = query(collection(db, `/artifacts/${APP_ID}/users/${user.uid}/medications`), where("status", "==", "archived"));
                
                const listener = onSnapshot(medsQuery, (snapshot) => {
                    listEl.innerHTML = '';
                    if (snapshot.empty) {
                        listEl.innerHTML = `<p class="text-center text-gray-500">لا توجد أدوية في السجل.</p>`;
                        return;
                    }
                    snapshot.docs.forEach(docSnap => {
                        const med = docSnap.data();
                        const item = document.createElement('div');
                        item.className = 'bg-white p-4 rounded-lg shadow-sm opacity-70'; // Slightly faded for archived
                        item.innerHTML = `<h4 class="font-bold text-lg">${med.name}</h4><p class="text-sm text-gray-600">${med.dosage}</p>`;
                        listEl.appendChild(item);
                    });
                });
                activeListeners.push(listener);
            }

            /**
             * Renders the patient's linked doctors tab.
             * @param {HTMLElement} container - The container element for the tab.
             * @param {Object} user - Firebase User object.
             * @param {Object} userData - Patient's custom user data.
             */
            function renderPatientDoctorsTab(container, user, userData) {
                container.innerHTML = `<div id="doctors-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"><p>جاري تحميل قائمة الأطباء...</p></div>`;
                const listEl = container.querySelector('#doctors-list');

                if (!userData.linkedDoctors || userData.linkedDoctors.length === 0) {
                    listEl.innerHTML = `<p class="text-center text-gray-500 col-span-full">لا يوجد لديك أطباء مرتبطون حالياً.</p>`;
                    return;
                }

                listEl.innerHTML = '';
                userData.linkedDoctors.forEach(async (doctorId) => {
                    const doctorDocRef = doc(db, `/artifacts/${APP_ID}/users`, doctorId);
                    const doctorDoc = await getDoc(doctorDocRef);
                    if (doctorDoc.exists()) {
                        const doctor = doctorDoc.data();
                        const item = document.createElement('div');
                        item.className = 'bg-white p-4 rounded-lg shadow-sm flex flex-col justify-between';
                        item.innerHTML = `
                            <div>
                                <h4 class="font-bold text-lg">${doctor.name || 'طبيب غير مسمى'}</h4>
                                <p class="text-sm text-gray-600">${doctor.specialty || 'بدون تخصص'}</p>
                                <p class="text-xs text-gray-400 mt-1">${doctor.email}</p>
                            </div>
                            <div class="mt-4 flex gap-2">
                                <button data-doctor-id="${doctorId}" class="chat-btn flex-1 bg-teal-500 text-white py-2 rounded-lg hover:bg-teal-600"><i class="fas fa-comments mr-2"></i>مراسلة</button>
                                <button data-doctor-id="${doctorId}" data-doctor-name="${doctor.name || 'طبيب'}" class="rate-btn flex-1 bg-yellow-500 text-white py-2 rounded-lg hover:bg-yellow-600"><i class="fas fa-star mr-2"></i>تقييم</button>
                            </div>
                        `;
                        listEl.appendChild(item);
                    }
                });

                // Event delegation for chat and rate buttons
                listEl.addEventListener('click', (e) => {
                    const chatBtn = e.target.closest('.chat-btn');
                    const rateBtn = e.target.closest('.rate-btn');
                    if(chatBtn) {
                        const doctorId = chatBtn.dataset.doctorId;
                        renderChatModal(user.uid, doctorId); // Patient's UID, Doctor's UID
                    }
                    if(rateBtn) {
                        const { doctorId, doctorName } = rateBtn.dataset;
                        renderRatingModal(doctorId, doctorName);
                    }
                });
            }

            /**
             * Renders the patient's profile tab.
             * @param {HTMLElement} container - The container element for the tab.
             * @param {Object} user - Firebase User object.
             * @param {Object} userData - Patient's custom user data.
             */
            function renderPatientProfileTab(container, user, userData) {
                container.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <h3 class="text-xl font-bold mb-6">المعلومات الشخصية</h3>
                            <div class="mb-4">
                                <label class="font-bold text-gray-600">رمز المشاركة (UID):</label>
                                <p class="text-lg text-teal-600 font-mono select-all">${user.uid}</p>
                                <p class="text-xs text-gray-500">شارك هذا الرمز مع طبيبك ليتمكن من متابعتك.</p>
                            </div>
                            <form id="profileForm" class="space-y-4">
                                <input id="profileName" placeholder="الاسم الكامل" class="w-full p-3 border rounded-lg" value="${userData.name || ''}">
                                <input id="profileAge" type="number" placeholder="العمر" class="w-full p-3 border rounded-lg" value="${userData.age || ''}">
                                <textarea id="profileConditions" placeholder="الحالات الصحية (إن وجدت)" class="w-full p-3 border rounded-lg h-24">${userData.conditions || ''}</textarea>
                                <button type="submit" id="saveProfileBtn" class="mt-2 w-full bg-teal-600 text-white font-bold py-3 rounded-lg hover:bg-teal-700">حفظ المعلومات</button>
                            </form>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">الأمان</h3>
                            <div class="flex justify-between items-center">
                                <span>التحقق بخطوتين</span>
                                <button id="setup-2fa-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">${userData.is2FAEnabled ? 'تعطيل' : 'تفعيل'}</button>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">زيادة أمان حسابك. (هذه الميزة هي محاكاة تجريبية).</p>
                        </div>
                    </div>
                `;
                
                container.querySelector('#setup-2fa-btn').addEventListener('click', () => {
                    render2FASetupModal(user.uid, userData.is2FAEnabled);
                });

                container.querySelector('#profileForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const submitBtn = e.submitter;
                    showButtonLoading(submitBtn, true, 'حفظ المعلومات');

                    // SECURITY NOTE: Perform server-side validation and sanitization for all user inputs
                    // before saving to Firestore. This client-side validation is for basic UX.
                    const profileData = {
                        name: container.querySelector('#profileName').value,
                        age: container.querySelector('#profileAge').value,
                        conditions: container.querySelector('#profileConditions').value
                    };
                    const userDocRef = doc(db, `/artifacts/${APP_ID}/users`, user.uid);
                    try {
                        await updateDoc(userDocRef, profileData);
                        showNotification("تم حفظ المعلومات بنجاح!");
                    } catch (error) {
                        console.error("Error saving profile:", error);
                        showNotification("حدث خطأ أثناء حفظ المعلومات.", "error");
                    } finally {
                        showButtonLoading(submitBtn, false);
                    }
                });
            }

            /**
             * Renders the patient's connection requests tab.
             * @param {HTMLElement} container - The container element for the tab.
             * @param {Object} user - Firebase User object.
             */
            function renderPatientRequestsTab(container, user) {
                container.innerHTML = `<div id="requests-list" class="space-y-4"><p class="text-center text-gray-500">جاري تحميل الطلبات...</p></div>`;
                const listEl = container.querySelector('#requests-list');

                const requestsRef = collection(db, `/artifacts/${APP_ID}/public/data/connectionRequests`);
                // Query for pending requests sent to the current patient
                const q = query(requestsRef, where("to", "==", user.uid), where("status", "==", "pending"));
                
                const requestsListener = onSnapshot(q, (snapshot) => {
                    listEl.innerHTML = ''; // Clear existing list
                    if (snapshot.empty) {
                        listEl.innerHTML = `<p class="text-center text-gray-500">لا توجد طلبات ربط جديدة.</p>`;
                        return;
                    }
                    
                    snapshot.docs.forEach(async (docSnap) => {
                        const request = docSnap.data();
                        const doctorDoc = await getDoc(doc(db, `/artifacts/${APP_ID}/users`, request.from));
                        const doctorEmail = doctorDoc.exists() ? doctorDoc.data().email : "طبيب غير معروف";
                        
                        const item = document.createElement('div');
                        item.className = 'bg-white p-4 rounded-lg shadow-sm flex justify-between items-center flex-wrap gap-2';
                        item.innerHTML = `
                            <p>طلب ربط من الطبيب: <span class="font-bold">${doctorEmail}</span></p>
                            <div class="flex gap-2">
                                <button data-id="${docSnap.id}" data-action="accept" class="request-btn bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600">قبول</button>
                                <button data-id="${docSnap.id}" data-action="decline" class="request-btn bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600">رفض</button>
                            </div>`;
                        listEl.appendChild(item);
                    });
                });

                listEl.addEventListener('click', (e) => {
                    const button = e.target.closest('.request-btn');
                    if (button) {
                        const requestId = button.dataset.id;
                        const action = button.dataset.action;
                        handleConnectionRequest(requestId, action === 'accept');
                    }
                });

                activeListeners.push(requestsListener);
            }

            /**
             * Handles accepting or declining a connection request.
             * @param {string} requestId - The ID of the connection request document.
             * @param {boolean} accepted - True if accepted, false if declined.
             */
            async function handleConnectionRequest(requestId, accepted) {
                const requestRef = doc(db, `/artifacts/${APP_ID}/public/data/connectionRequests`, requestId);
                const requestDoc = await getDoc(requestRef);
                if (!requestDoc.exists()) {
                    showNotification("لم يتم العثور على الطلب.", "error");
                    return;
                }

                try {
                    if (accepted) {
                        const { from, to } = requestDoc.data();
                        const batch = writeBatch(db);
                        
                        batch.update(requestRef, { status: "accepted" });
                        batch.update(doc(db, `/artifacts/${APP_ID}/users`, from), { linkedPatients: arrayUnion(to) });
                        batch.update(doc(db, `/artifacts/${APP_ID}/users`, to), { linkedDoctors: arrayUnion(from) });
                        
                        await batch.commit();
                        showNotification("تم قبول طلب الربط بنجاح!");
                    } else {
                        await updateDoc(requestRef, { status: "declined" });
                        showNotification("تم رفض طلب الربط.");
                    }
                } catch (error) {
                    console.error("Error handling connection request:", error);
                    showNotification("حدث خطأ أثناء معالجة الطلب.", "error");
                }
            }

            // --- 7. DOCTOR DASHBOARD ---

            const doctorTabs = {
                patients: { title: "مرضاي", icon: '<i class="fas fa-users"></i>', onRender: renderDoctorPatientsTab },
                addPatient: { title: "إرسال طلب ربط", icon: '<i class="fas fa-user-plus"></i>', onRender: renderDoctorAddPatientTab },
                profile: { title: "ملفي الشخصي", icon: '<i class="fas fa-user-cog"></i>', onRender: renderDoctorProfileTab },
                stats: { title: "إحصائيات", icon: '<i class="fas fa-chart-line"></i>', onRender: renderDoctorStatsTab }
            };
            
            /**
             * Renders the doctor's profile tab.
             * @param {HTMLElement} container - The container element for the tab.
             * @param {Object} user - Firebase User object.
             * @param {Object} userData - Doctor's custom user data.
             */
            function renderDoctorProfileTab(container, user, userData) {
                 container.innerHTML = `
                    <div class="bg-white p-6 rounded-2xl shadow-lg max-w-lg mx-auto">
                        <h3 class="text-xl font-bold mb-6">المعلومات الشخصية للطبيب</h3>
                        <form id="doctorProfileForm" class="space-y-4">
                            <input id="profileName" placeholder="الاسم الكامل" class="w-full p-3 border rounded-lg" value="${userData.name || ''}" required>
                            <input id="profileSpecialty" placeholder="التخصص (مثال: طبيب عام، طبيب أطفال)" class="w-full p-3 border rounded-lg" value="${userData.specialty || ''}">
                            <button type="submit" id="saveDoctorProfileBtn" class="mt-2 w-full bg-teal-600 text-white font-bold py-3 rounded-lg hover:bg-teal-700">حفظ المعلومات</button>
                        </form>
                    </div>
                `;

                container.querySelector('#doctorProfileForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const submitBtn = e.submitter;
                    showButtonLoading(submitBtn, true, 'حفظ المعلومات');

                    // SECURITY NOTE: Perform server-side validation and sanitization for all user inputs
                    // before saving to Firestore. This client-side validation is for basic UX.
                    const profileData = {
                        name: container.querySelector('#profileName').value,
                        specialty: container.querySelector('#profileSpecialty').value,
                    };
                    const userDocRef = doc(db, `/artifacts/${APP_ID}/users`, user.uid);
                    try {
                        await updateDoc(userDocRef, profileData);
                        showNotification("تم حفظ معلوماتك بنجاح!");
                    } catch (error) {
                        console.error("Error saving doctor profile:", error);
                        showNotification("حدث خطأ أثناء حفظ معلومات الطبيب.", "error");
                    } finally {
                        showButtonLoading(submitBtn, false);
                    }
                });
            }
            
            /**
             * Renders the doctor's statistics tab.
             * @param {HTMLElement} container - The container element for the tab.
             * @param {Object} user - Firebase User object.
             * @param {Object} userData - Doctor's custom user data.
             */
            async function renderDoctorStatsTab(container, user, userData) {
                container.innerHTML = `
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <canvas id="doctorStatsChart"></canvas>
                    </div>
                `;

                const patientCount = userData.linkedPatients?.length || 0;
                let totalMeds = 0;
                let totalTakenDoses = 0;

                if (patientCount > 0) {
                    // Fetch medication counts and taken doses for all linked patients
                    const patientMedsPromises = userData.linkedPatients.map(async (patientId) => {
                        const medsRef = collection(db, `/artifacts/${APP_ID}/users/${patientId}/medications`);
                        const medsSnapshot = await getDocs(medsRef);
                        let patientMedsAddedByDoctor = 0;
                        let patientTakenDoses = 0;
                        medsSnapshot.forEach(docSnap => {
                            const med = docSnap.data();
                            if (med.addedBy === 'doctor') {
                                patientMedsAddedByDoctor++;
                            }
                            patientTakenDoses += med.takenDates?.length || 0;
                        });
                        return { medsAddedByDoctor: patientMedsAddedByDoctor, takenDoses: patientTakenDoses };
                    });
                    const patientStats = await Promise.all(patientMedsPromises);
                    totalMeds = patientStats.reduce((sum, stats) => sum + stats.medsAddedByDoctor, 0);
                    totalTakenDoses = patientStats.reduce((sum, stats) => sum + stats.takenDoses, 0);
                }

                const ctx = document.getElementById('doctorStatsChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['المرضى المرتبطون', 'الأدوية الموصوفة', 'جرعات تم أخذها'],
                        datasets: [{
                            label: 'إحصائيات',
                            data: [patientCount, totalMeds, totalTakenDoses],
                            backgroundColor: [
                                'rgba(13, 148, 136, 0.6)', // Teal
                                'rgba(59, 130, 246, 0.6)', // Blue
                                'rgba(251, 191, 36, 0.6)' // Yellow
                            ],
                            borderColor: [
                                'rgba(13, 148, 136, 1)',
                                'rgba(59, 130, 246, 1)',
                                'rgba(251, 191, 36, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }


            /**
             * Renders the doctor's linked patients tab.
             * @param {HTMLElement} container - The container element for the tab.
             * @param {Object} user - Firebase User object.
             * @param {Object} userData - Doctor's custom user data.
             */
            function renderDoctorPatientsTab(container, user, userData) {
                container.innerHTML = `
                    <div class="mb-4">
                        <input type="text" id="patient-search" placeholder="ابحث عن مريض بالاسم أو رقم الملف..." class="w-full p-3 border rounded-lg">
                    </div>
                    <div id="patients-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"><p>جاري تحميل قائمة المرضى...</p></div>
                `;
                const listEl = container.querySelector('#patients-list');
                const searchInput = container.querySelector('#patient-search');

                let patientCards = []; // Cache for patient cards to facilitate searching

                const renderList = (filter = '') => {
                    listEl.innerHTML = '';
                    const lowerCaseFilter = filter.toLowerCase();
                    const filteredCards = patientCards.filter(card => 
                        card.name.toLowerCase().includes(lowerCaseFilter) ||
                        (card.fileNumber && card.fileNumber.toLowerCase().includes(lowerCaseFilter))
                    );

                    if (filteredCards.length === 0) {
                         listEl.innerHTML = `<p class="text-center text-gray-500 col-span-full">لا يوجد مرضى مطابقون للبحث.</p>`;
                         return;
                    }
                    filteredCards.forEach(card => {
                        const item = document.createElement('div');
                        item.className = 'bg-white p-4 rounded-lg shadow-sm';
                        item.innerHTML = card.html;
                        listEl.appendChild(item);
                    });
                };

                searchInput.addEventListener('input', (e) => renderList(e.target.value));

                if (!userData.linkedPatients || userData.linkedPatients.length === 0) {
                    listEl.innerHTML = `<p class="text-center text-gray-500 col-span-full">لا يوجد لديك مرضى مرتبطون حالياً.</p>`;
                    return;
                }

                listEl.innerHTML = ''; // Clear initial loading message
                // Fetch details for each linked patient
                userData.linkedPatients.forEach(async (patientId) => {
                    const patientDocRef = doc(db, `/artifacts/${APP_ID}/users`, patientId);
                    const patientDoc = await getDoc(patientDocRef);
                    if (patientDoc.exists()) {
                        const patient = patientDoc.data();
                        patientCards.push({
                            name: patient.name || 'مريض غير مسمى',
                            fileNumber: patient.fileNumber || '',
                            html: `
                                <h4 class="font-bold text-lg">${patient.name || 'مريض غير مسمى'}</h4>
                                <p class="text-sm text-gray-600">رقم الملف: ${patient.fileNumber || 'N/A'}</p>
                                <p class="text-sm text-gray-600">العمر: ${patient.age || 'غير محدد'}</p>
                                <div class="mt-4 flex gap-2">
                                     <button data-patient-id="${patientId}" data-patient-name="${patient.name || 'مريض'}" class="details-btn flex-1 bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600"><i class="fas fa-notes-medical mr-2"></i>التفاصيل</button>
                                     <button data-patient-id="${patientId}" class="chat-btn flex-1 bg-teal-500 text-white py-2 rounded-lg hover:bg-teal-600"><i class="fas fa-comments mr-2"></i>مراسلة</button>
                                </div>
                            `
                        });
                        renderList(searchInput.value); // Re-render list with new patient and current filter
                    }
                });

                // Event delegation for details and chat buttons
                listEl.addEventListener('click', (e) => {
                    const detailsBtn = e.target.closest('.details-btn');
                    const chatBtn = e.target.closest('.chat-btn');
                    if(detailsBtn) {
                        const { patientId, patientName } = detailsBtn.dataset;
                        showPatientDetailsModal(patientId, patientName);
                    }
                    if(chatBtn) {
                        const patientId = chatBtn.dataset.patientId;
                        renderChatModal(patientId, user.uid); // Patient's UID, Doctor's UID
                    }
                });
            }

            /**
             * Displays a modal with detailed information about a specific patient for the doctor.
             * @param {string} patientId - The UID of the patient.
             * @param {string} patientName - The name of the patient.
             */
            async function showPatientDetailsModal(patientId, patientName) {
                const modal = document.getElementById('doctorModal');
                const patientDoc = await getDoc(doc(db, `/artifacts/${APP_ID}/users`, patientId));
                const patientData = patientDoc.data();

                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h3 class="text-xl font-bold text-teal-700">تفاصيل ${patientName}</h3>
                                <p class="text-sm text-gray-500">UID: ${patientId}</p>
                            </div>
                            <button id="closeDoctorModal" class="text-2xl text-gray-500 hover:text-gray-800">&times;</button>
                        </div>

                        <div class="mb-4 p-4 bg-gray-100 rounded-lg">
                            <h4 class="font-bold mb-2">رقم الملف</h4>
                            <div class="flex gap-2 items-center">
                                <input id="file-number-input" type="text" class="flex-grow p-2 border rounded-lg" value="${patientData.fileNumber || ''}" placeholder="أدخل رقم الملف">
                                <button id="random-file-number-btn" class="p-2 bg-gray-200 rounded-lg hover:bg-gray-300" title="توليد رقم عشوائي"><i class="fas fa-random"></i></button>
                                <button id="save-file-number-btn" class="p-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600" title="حفظ رقم الملف"><i class="fas fa-save"></i></button>
                            </div>
                        </div>

                        <div class="mb-4">
                            <button id="add-med-btn" class="w-full bg-teal-600 text-white font-bold py-2 rounded-lg hover:bg-teal-700"><i class="fas fa-plus mr-2"></i>إضافة دواء جديد</button>
                        </div>
                        <div id="patient-meds-list" class="text-gray-700 overflow-y-auto p-2 space-y-3">
                            <p class="text-center"><i class="fas fa-spinner fa-spin text-2xl"></i></p>
                        </div>
                    </div>
                `;
                modal.classList.add('active');
                cleanupListeners(); // Clean up listeners from previous modal instances

                // Event listener for clicking outside the modal content to close it
                modal.addEventListener('click', function handler(e) {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                        cleanupListeners(); // Ensure listeners are cleaned if closed by clicking outside
                        modal.removeEventListener('click', handler);
                    }
                });
                
                modal.querySelector('#closeDoctorModal').addEventListener('click', () => {
                    modal.classList.remove('active');
                    cleanupListeners(); // Clean up listeners when modal is closed
                });
                
                modal.querySelector('#add-med-btn').addEventListener('click', () => renderMedicationFormModal(patientId));
                
                modal.querySelector('#random-file-number-btn').addEventListener('click', () => {
                    modal.querySelector('#file-number-input').value = `F-${Math.floor(1000 + Math.random() * 9000)}`;
                });

                modal.querySelector('#save-file-number-btn').addEventListener('click', async (e) => {
                    const saveBtn = e.currentTarget;
                    showButtonLoading(saveBtn, true, '<i class="fas fa-save"></i>');
                    const fileNumber = modal.querySelector('#file-number-input').value;
                    // SECURITY NOTE: Perform server-side validation and sanitization for fileNumber
                    try {
                        await updateDoc(doc(db, `/artifacts/${APP_ID}/users`, patientId), { fileNumber });
                        showNotification("تم حفظ رقم الملف بنجاح!");
                    } catch (error) {
                        console.error("Error saving file number:", error);
                        showNotification("حدث خطأ أثناء حفظ رقم الملف.", "error");
                    } finally {
                        showButtonLoading(saveBtn, false);
                    }
                });

                const medsListEl = modal.querySelector('#patient-meds-list');
                // Listen for all medications (active and archived) for this patient
                const medsQuery = query(collection(db, `/artifacts/${APP_ID}/users/${patientId}/medications`), orderBy("createdAt", "desc"));
                
                const listener = onSnapshot(medsQuery, (snapshot) => {
                    medsListEl.innerHTML = '';
                    if (snapshot.empty) {
                        medsListEl.innerHTML = '<p class="text-center text-gray-500">لا توجد أدوية لهذا المريض.</p>';
                        return;
                    }
                    snapshot.docs.forEach(docSnap => {
                        const med = docSnap.data();
                        const item = document.createElement('div');
                        // Add status class for visual distinction (e.g., archived meds might be faded)
                        const statusClass = med.status === 'archived' ? 'opacity-70' : '';
                        const createdAtDate = med.createdAt ? new Date(med.createdAt.toDate()).toLocaleDateString('ar-EG-u-nu-latn') : 'N/A';
                        item.className = `bg-gray-50 p-3 rounded-lg flex justify-between items-center ${statusClass}`;
                        item.innerHTML = `
                            <div>
                                <h4 class="font-bold">${med.name}</h4>
                                <p class="text-sm text-gray-600">${med.dosage} | ${med.times.join(', ')}</p>
                                <p class="text-xs text-gray-500">تعليمات: ${med.instructions || 'لا توجد'}</p>
                                <p class="text-xs text-gray-500">تاريخ الإضافة: ${createdAtDate}</p>
                                <p class="text-xs text-gray-500">تم أخذ الجرعات: ${med.takenDates?.length || 0}</p>
                            </div>
                            <div class="flex gap-2">
                                <button data-med-id="${docSnap.id}" class="edit-med-btn text-blue-500 hover:text-blue-700" title="تعديل الدواء"><i class="fas fa-edit"></i></button>
                                <button data-med-id="${docSnap.id}" class="delete-med-btn text-red-500 hover:text-red-700" title="حذف الدواء"><i class="fas fa-trash"></i></button>
                            </div>
                        `;
                        medsListEl.appendChild(item);
                    });
                });
                activeListeners.push(listener); // Add listener to activeListeners array

                medsListEl.addEventListener('click', async (e) => {
                    const editBtn = e.target.closest('.edit-med-btn');
                    const deleteBtn = e.target.closest('.delete-med-btn');

                    if (editBtn) {
                        const medId = editBtn.dataset.medId; // Corrected from med-id
                        const medRef = doc(db, `/artifacts/${APP_ID}/users/${patientId}/medications`, medId);
                        const medSnap = await getDoc(medRef);
                        if (medSnap.exists()) {
                            renderMedicationFormModal(patientId, medId, medSnap.data());
                        }
                    }

                    if (deleteBtn) {
                        const medId = deleteBtn.dataset.medId; // Corrected from med-id
                        renderConfirmationModal("هل أنت متأكد من حذف هذا الدواء؟", async () => {
                            try {
                                await deleteDoc(doc(db, `/artifacts/${APP_ID}/users/${patientId}/medications`, medId));
                                showNotification("تم حذف الدواء بنجاح.", "success");
                            } catch (error) {
                                console.error("Error deleting medication:", error);
                                showNotification("حدث خطأ أثناء حذف الدواء.", "error");
                            }
                        });
                    }
                });
            }
            
            /**
             * Renders a modal for adding or editing a medication for a patient (used by doctors).
             * @param {string} patientId - The UID of the patient.
             * @param {string|null} medId - The ID of the medication to edit, or null for new.
             * @param {Object} medData - Existing medication data if editing.
             */
            function renderMedicationFormModal(patientId, medId = null, medData = {}) {
                const isEditing = medId !== null;
                const modal = document.getElementById('medicationFormModal');
                const dosageOptions = ["1 حبة", "2 حبة", "نصف حبة", "5 مل", "10 مل", "جرعة واحدة"];
                const frequencyOptions = { 1: "مرة واحدة يومياً", 2: "مرتين يومياً", 3: "3 مرات يومياً", 4: "4 مرات يومياً"};

                // Pre-fill times for editing
                const initialTimes = medData.times || [];
                const initialFrequency = initialTimes.length > 0 ? initialTimes.length.toString() : '';

                modal.innerHTML = `
                    <div class="modal-content">
                        <h3 class="text-xl font-bold mb-6">${isEditing ? 'تعديل الدواء' : 'إضافة دواء جديد'}</h3>
                        <form id="doctorMedForm" class="space-y-4">
                            <input id="docMedName" placeholder="اسم الدواء" class="w-full p-3 border rounded-lg" value="${medData.name || ''}" required>
                            <select id="docMedDosage" class="w-full p-3 border rounded-lg">${dosageOptions.map(o => `<option value="${o}" ${medData.dosage === o ? 'selected' : ''}>${o}</option>`).join('')}</select>
                            
                            <select id="docMedFrequency" class="w-full p-3 border rounded-lg"><option value="">كم مرة في اليوم؟</option>${Object.entries(frequencyOptions).map(([val, text]) => `<option value="${val}" ${initialFrequency === val ? 'selected' : ''}>${text}</option>`).join('')}</select>
                            <div id="docMedTimesContainer" class="grid grid-cols-2 md:grid-cols-4 gap-4 ${initialFrequency ? '' : 'hidden'}"></div>

                            <textarea id="docMedInstructions" placeholder="تعليمات وتحذيرات" class="w-full p-3 border rounded-lg h-24">${medData.instructions || ''}</textarea>
                            <div class="flex gap-4 mt-4">
                                <button type="button" id="cancelMedForm" class="flex-1 bg-gray-300 text-gray-800 font-bold py-3 rounded-lg hover:bg-gray-400">إلغاء</button>
                                <button type="submit" id="submitMedFormBtn" class="flex-1 bg-teal-600 text-white font-bold py-3 rounded-lg hover:bg-teal-700">${isEditing ? 'حفظ التعديلات' : 'إضافة الدواء'}</button>
                            </div>
                        </form>
                    </div>
                `;
                modal.classList.add('active');

                // Event listener for clicking outside the modal content to close it
                modal.addEventListener('click', function handler(e) {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                        modal.removeEventListener('click', handler);
                    }
                });

                const docMedFrequencySelect = modal.querySelector('#docMedFrequency');
                const docMedTimesContainer = modal.querySelector('#docMedTimesContainer');

                // Function to render time inputs based on frequency
                const renderTimeInputs = (count, existingTimes = []) => {
                    docMedTimesContainer.innerHTML = '';
                    const timePresets = [{icon:'☀️', label:'صباحاً'}, {icon:'🕛', label:'ظهراً'}, {icon:'�', label:'مساءً'}, {icon:'🛌', label:'قبل النوم'}];
                    if (count > 0) {
                        docMedTimesContainer.classList.remove('hidden');
                        for (let i = 0; i < count; i++) {
                            const preset = timePresets[i] || {icon: '⏰', label: `الوقت ${i+1}`};
                            const timeValue = existingTimes[i] || '';
                            docMedTimesContainer.innerHTML += `<div class="flex items-center gap-2"><label class="w-28">${preset.icon} ${preset.label}</label><input type="time" class="doc-med-time-input flex-1 p-2 border rounded-lg" value="${timeValue}" required></div>`;
                        }
                    } else {
                        docMedTimesContainer.classList.add('hidden');
                    }
                };

                // Initial render of time inputs if editing an existing medication
                if (isEditing && initialTimes.length > 0) {
                    renderTimeInputs(initialTimes.length, initialTimes);
                }

                // Event listener for frequency select to dynamically generate time inputs
                docMedFrequencySelect.addEventListener('change', (e) => {
                    const count = parseInt(e.target.value, 10);
                    renderTimeInputs(count); // Pass empty array for new selection
                });

                modal.querySelector('#cancelMedForm').addEventListener('click', () => modal.classList.remove('active'));

                modal.querySelector('#doctorMedForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const submitBtn = e.submitter;
                    showButtonLoading(submitBtn, true, isEditing ? 'حفظ التعديلات' : 'إضافة الدواء');

                    // SECURITY NOTE: Perform server-side validation and sanitization for all user inputs
                    // before saving to Firestore. This client-side validation is for basic UX.
                    const updatedMedData = {
                        name: modal.querySelector('#docMedName').value,
                        dosage: modal.querySelector('#docMedDosage').value,
                        instructions: modal.querySelector('#docMedInstructions').value,
                        times: Array.from(modal.querySelectorAll('.doc-med-time-input')).map(input => input.value),
                        addedBy: 'doctor',
                        status: 'active', // Ensure status is set
                        ...(isEditing ? {} : { createdAt: serverTimestamp(), takenDates: [] }) // Only set createdAt and takenDates for new meds
                    };

                    const collectionRef = collection(db, `/artifacts/${APP_ID}/users/${patientId}/medications`);
                    try {
                        if (isEditing) {
                            await updateDoc(doc(collectionRef, medId), updatedMedData);
                            showNotification("تم تعديل الدواء بنجاح!");
                        } else {
                            await addDoc(collectionRef, updatedMedData);
                            showNotification("تمت إضافة الدواء بنجاح!");
                        }
                        modal.classList.remove('active');
                    } catch (error) {
                        console.error("Error saving medication:", error);
                        showNotification("حدث خطأ أثناء حفظ الدواء.", "error");
                    } finally {
                        showButtonLoading(submitBtn, false);
                    }
                });
            }


            /**
             * Renders the doctor's "Add Patient" tab for sending connection requests.
             * @param {HTMLElement} container - The container element for the tab.
             * @param {Object} user - Firebase User object.
             */
            function renderDoctorAddPatientTab(container, user) {
                container.innerHTML = `
                    <div class="bg-white p-6 rounded-2xl shadow-lg max-w-lg mx-auto">
                        <h3 class="text-xl font-bold mb-4">إرسال طلب ربط لمريض</h3>
                        <p class="text-gray-600 mb-4">أدخل رمز المشاركة الخاص بالمريض (UID) لإرسال طلب متابعة.</p>
                        <form id="addPatientForm" class="flex flex-col sm:flex-row gap-2">
                            <input id="patientCodeInput" placeholder="رمز المريض" class="flex-grow p-3 border rounded-lg" required>
                            <button type="submit" id="sendRequestBtn" class="bg-teal-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-teal-700">إرسال</button>
                        </form>
                    </div>`;
                
                container.querySelector('#addPatientForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const submitBtn = e.submitter;
                    showButtonLoading(submitBtn, true, 'إرسال');

                    const patientId = container.querySelector('#patientCodeInput').value.trim();
                    
                    if (patientId === user.uid) {
                        showNotification("لا يمكنك إضافة نفسك.", "error");
                        showButtonLoading(submitBtn, false);
                        return;
                    }

                    try {
                        const patientDoc = await getDoc(doc(db, `/artifacts/${APP_ID}/users`, patientId));
                        if (!patientDoc.exists() || patientDoc.data().role !== 'patient') {
                            showNotification("رمز المريض غير صحيح أو غير موجود.", "error");
                            showButtonLoading(submitBtn, false);
                            return;
                        }

                        // Check if a pending request already exists
                        const existingRequestsQuery = query(
                            collection(db, `/artifacts/${APP_ID}/public/data/connectionRequests`),
                            where("from", "==", user.uid),
                            where("to", "==", patientId),
                            where("status", "==", "pending")
                        );
                        const existingRequestsSnapshot = await getDocs(existingRequestsQuery);
                        if (!existingRequestsSnapshot.empty) {
                            showNotification("لقد أرسلت طلبًا لهذا المريض بالفعل وهو قيد الانتظار.", "error");
                            showButtonLoading(submitBtn, false);
                            return;
                        }

                        const requestRef = collection(db, `/artifacts/${APP_ID}/public/data/connectionRequests`);
                        await addDoc(requestRef, {
                            from: user.uid,
                            to: patientId,
                            status: "pending",
                            createdAt: serverTimestamp()
                        });
                        showNotification("تم إرسال الطلب بنجاح!");
                        e.target.reset(); // Reset the form
                    } catch (error) {
                        console.error("Error sending connection request:", error);
                        showNotification("حدث خطأ أثناء إرسال الطلب.", "error");
                    } finally {
                        showButtonLoading(submitBtn, false);
                    }
                });
            }
            
            // --- 8. CHAT & NOTIFICATIONS ---

            /**
             * Sets up a real-time listener for chat notifications for a doctor.
             * @param {string} doctorId - The UID of the doctor.
             */
            function setupDoctorNotificationListeners(doctorId) {
                const chatsRef = collection(db, `/artifacts/${APP_ID}/public/data/chats`);
                // Query for chats where the doctor is a participant
                const q = query(chatsRef, where("participants", "array-contains", doctorId));

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        // Only notify for new messages or modified messages (e.g., status change)
                        if (change.type === "modified" || change.type === "added") {
                            const chatData = change.doc.data();
                            // Check if the last message is new and not from the doctor themselves
                            if (chatData.lastMessage && chatData.lastMessage.senderId !== doctorId) {
                                 if(chatData.lastMessage.status === 'urgent' || chatData.lastMessage.status === 'emergency') {
                                    showNotification(`رسالة ${chatData.lastMessage.status === 'urgent' ? 'عاجلة' : 'طارئة'} من مريض!`, 'error');
                                 } else if (chatData.lastMessage.status === 'normal' && change.type === "added") {
                                     // Basic notification for new normal messages
                                     showNotification("رسالة جديدة من مريض.", "success");
                                 }
                            }
                        }
                    });
                });
                activeListeners.push(unsubscribe); // Add listener to activeListeners array
            }


            /**
             * Renders the chat modal for communication between a patient and a doctor.
             * @param {string} patientId - The UID of the patient.
             * @param {string} doctorId - The UID of the doctor.
             */
            async function renderChatModal(patientId, doctorId) {
                const modal = document.getElementById('chatModal');
                const currentUser = auth.currentUser;
                const currentUserDoc = await getDoc(doc(db, `/artifacts/${APP_ID}/users`, currentUser.uid));
                const isDoctor = currentUserDoc.data().role === 'doctor';
                
                const otherUserId = isDoctor ? patientId : doctorId;
                const otherUserDoc = await getDoc(doc(db, `/artifacts/${APP_ID}/users`, otherUserId));
                const otherUserName = otherUserDoc.data().name || 'مستخدم';
                
                // Create a consistent chat ID by sorting participant UIDs
                const chatId = [patientId, doctorId].sort().join('_');
                const chatDocRef = doc(db, `/artifacts/${APP_ID}/public/data/chats`, chatId);
                const messagesRef = collection(chatDocRef, 'messages');

                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="flex justify-between items-center mb-4 border-b pb-3">
                            <h3 class="text-xl font-bold text-teal-700">محادثة مع ${otherUserName}</h3>
                            <button id="closeChatModal" class="text-2xl text-gray-500 hover:text-gray-800">&times;</button>
                        </div>
                        <div id="chat-messages" class="flex-grow overflow-y-auto p-2 flex flex-col gap-3 mb-4">
                            <!-- Messages will be rendered here -->
                        </div>
                        <form id="chat-form" class="flex gap-2 items-center">
                            <input type="file" id="file-input" class="hidden">
                            <button type="button" id="attach-file-btn" class="p-3 bg-gray-200 rounded-lg hover:bg-gray-300" title="إرفاق ملف"><i class="fas fa-paperclip"></i></button>
                            <input id="chat-input" class="flex-grow p-3 border rounded-lg" placeholder="اكتب رسالتك..." required>
                            <select id="chat-status" class="border rounded-lg p-2 ${isDoctor ? 'hidden' : ''}">
                                <option value="normal" class="text-green-600">عادية</option>
                                <option value="urgent" class="text-yellow-600">عاجلة</option>
                                <option value="emergency" class="text-red-600">طارئة</option>
                            </select>
                            <button type="submit" id="sendMessageBtn" class="bg-teal-600 text-white font-bold p-3 rounded-lg hover:bg-teal-700" title="إرسال رسالة"><i class="fas fa-paper-plane"></i></button>
                        </form>
                    </div>
                `;
                modal.classList.add('active');
                cleanupListeners(); // Clean up listeners from previous modal instances

                // Event listener for clicking outside the modal content to close it
                modal.addEventListener('click', function handler(e) {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                        cleanupListeners(); // Ensure listeners are cleaned if closed by clicking outside
                        modal.removeEventListener('click', handler);
                    }
                });

                const messagesContainer = modal.querySelector('#chat-messages');
                const fileInput = modal.querySelector('#file-input');
                let lastDate = null; // To group messages by date

                // Query messages ordered by timestamp
                const q = query(messagesRef, orderBy("timestamp"));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    messagesContainer.innerHTML = ''; // Clear previous messages
                    lastDate = null; // Reset lastDate on full re-render
                    snapshot.forEach((doc) => {
                        const message = doc.data();
                        const messageDate = message.timestamp?.toDate().toLocaleDateString();

                        // Add date separator if date changes
                        if (messageDate !== lastDate) {
                            const dateEl = document.createElement('div');
                            dateEl.className = 'date-separator';
                            dateEl.textContent = new Date(message.timestamp?.toDate()).toLocaleDateString('ar-EG-u-nu-latn', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                            messagesContainer.appendChild(dateEl);
                            lastDate = messageDate;
                        }

                        const messageEl = document.createElement('div');
                        const isSent = message.senderId === currentUser.uid;
                        messageEl.className = `chat-bubble ${isSent ? 'chat-sent' : 'chat-received'}`;
                        
                        if (message.type === 'file') {
                            // SECURITY NOTE: Sanitize file names and URLs before displaying to prevent XSS.
                            // Ensure fileURL is a valid and expected URL.
                            const safeFileName = DOMPurify.sanitize(message.fileName); // Example using DOMPurify
                            const safeFileURL = DOMPurify.sanitize(message.fileURL); // Example using DOMPurify
                            messageEl.innerHTML = `
                                <a href="${safeFileURL}" target="_blank" class="flex items-center gap-2 underline">
                                    <i class="fas fa-file-alt"></i>
                                    <span>${safeFileName}</span>
                                </a>
                            `;
                        } else {
                            // SECURITY NOTE: Sanitize message text to prevent XSS attacks.
                            // For example, if users can type HTML, it should be escaped or sanitized.
                            const sanitizedText = DOMPurify.sanitize(message.text); // Example using DOMPurify
                            // Display status badge for urgent/emergency messages
                            const statusBadge = `<span class="status-badge status-${message.status} mr-2">${message.status === 'urgent' ? 'عاجلة' : message.status === 'emergency' ? 'طارئة' : ''}</span>`;
                            messageEl.innerHTML = `
                                <p>${sanitizedText}</p>
                                <div class="text-xs mt-1 opacity-75 flex justify-end items-center">
                                    ${message.status !== 'normal' ? statusBadge : ''}
                                    ${new Date(message.timestamp?.toDate()).toLocaleTimeString('ar-EG-u-nu-latn', { hour: '2-digit', minute: '2-digit' })}
                                </div>
                            `;
                        }
                        messagesContainer.appendChild(messageEl);
                    });
                    messagesContainer.scrollTop = messagesContainer.scrollHeight; // Scroll to bottom
                });
                activeListeners.push(unsubscribe); // Add listener to activeListeners array

                modal.querySelector('#closeChatModal').addEventListener('click', () => {
                    modal.classList.remove('active');
                    unsubscribe(); // Unsubscribe from chat messages when modal is closed
                });
                
                modal.querySelector('#attach-file-btn').addEventListener('click', () => fileInput.click());
                
                fileInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    showLoading(true); // Show global loading for file upload
                    try {
                        const storageRef = ref(storage, `chat_files/${chatId}/${Date.now()}_${file.name}`);
                        await uploadBytes(storageRef, file);
                        const downloadURL = await getDownloadURL(storageRef);
                        
                        // SECURITY NOTE: File uploads should also be validated on the server-side
                        // (e.g., file type, size) to prevent malicious uploads.
                        const messageData = {
                            type: 'file',
                            fileName: file.name,
                            fileURL: downloadURL,
                            senderId: currentUser.uid,
                            status: 'normal', // Files are usually normal status
                            timestamp: serverTimestamp()
                        };
                        await addDoc(messagesRef, messageData);

                        // Update the main chat document with the last message for notifications
                        await setDoc(chatDocRef, { 
                            lastMessage: messageData,
                            participants: [patientId, doctorId] // Ensure participants array exists
                        }, { merge: true }); // Use merge to avoid overwriting other fields

                    } catch (error) {
                        console.error("File upload error:", error);
                        showNotification("فشل إرسال الملف.", "error");
                    } finally {
                        showLoading(false);
                        e.target.value = ''; // Clear file input
                    }
                });


                modal.querySelector('#chat-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const input = modal.querySelector('#chat-input');
                    const statusSelect = modal.querySelector('#chat-status');
                    const sendMessageBtn = modal.querySelector('#sendMessageBtn');
                    showButtonLoading(sendMessageBtn, true, '<i class="fas fa-paper-plane"></i>');

                    const text = input.value.trim();
                    if (text) {
                        // SECURITY NOTE: Sanitize message text on the server-side before saving to Firestore
                        // to prevent XSS attacks.
                        const messageData = {
                            type: 'text',
                            text: text,
                            senderId: currentUser.uid,
                            status: isDoctor ? 'normal' : statusSelect.value, // Doctors always send normal messages
                            timestamp: serverTimestamp()
                        };
                        try {
                            await addDoc(messagesRef, messageData);
                            
                            // Update the main chat document with the last message for notifications
                            await setDoc(chatDocRef, { 
                                lastMessage: messageData,
                                participants: [patientId, doctorId]
                            }, { merge: true });

                            input.value = ''; // Clear input field
                        } catch (error) {
                            console.error("Error sending message:", error);
                            showNotification("فشل إرسال الرسالة.", "error");
                        } finally {
                            showButtonLoading(sendMessageBtn, false);
                        }
                    } else {
                        showButtonLoading(sendMessageBtn, false);
                    }
                });
            }


            // --- 9. AI, RATING & 2FA MODALS ---

            /**
             * Displays a modal with AI-generated information about a medication.
             * @param {string} medName - The name of the medication to explain.
             */
            async function explainMedWithAI(medName) {
                const modal = document.getElementById('aiModal');
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-sky-700"><i class="fas fa-robot mr-2"></i>شرح الدواء بالذكاء الاصطناعي</h3>
                            <button id="closeAiModalBtn" class="text-2xl text-gray-500 hover:text-gray-800">&times;</button>
                        </div>
                        <div id="aiModalContent" class="text-gray-700 max-h-80 overflow-y-auto p-2">
                             <p class="text-center"><i class="fas fa-spinner fa-spin text-2xl"></i> جاري جلب المعلومات...</p>
                        </div>
                    </div>
                `;
                modal.classList.add('active');

                // Event listener for clicking outside the modal content to close it
                modal.addEventListener('click', function handler(e) {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                        modal.removeEventListener('click', handler);
                    }
                });

                modal.querySelector('#closeAiModalBtn').addEventListener('click', () => modal.classList.remove('active'));

                const contentEl = modal.querySelector('#aiModalContent');
                const prompt = `بصفتك مساعد صيدلي، اشرح دواء "${medName}" باللغة العربية المبسطة. ما هي استخداماته الرئيسية وما هي أهم النصائح العامة لتناوله؟ اجعل الشرح قصيراً وواضحاً.`;
                
                // SECURITY IMPROVEMENT: Instead of direct API call, call a secure backend endpoint.
                // This backend endpoint would then call the Gemini API using a securely stored key.
                // Example of how a backend call might look (assuming a Firebase Cloud Function):
                const backendEndpoint = 'YOUR_FIREBASE_CLOUD_FUNCTION_URL/explainMedication'; // استبدل هذا بعنوان URL لوظيفتك السحابية

                try {
                    const response = await fetch(backendEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            // SECURITY NOTE: If your backend requires authentication,
                            // pass the Firebase ID token here:
                            // 'Authorization': `Bearer ${await auth.currentUser.getIdToken()}`
                        },
                        body: JSON.stringify({ medName: medName, prompt: prompt })
                    });

                    if (!response.ok) {
                        // SECURITY NOTE: Avoid exposing backend error details to the client.
                        // Log full error on backend, send generic error to client.
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.explanation) { // Assuming your backend returns { explanation: "..." }
                        // SECURITY NOTE: Sanitize the AI-generated text before displaying it
                        // to prevent potential XSS if the AI output contains malicious HTML.
                        const sanitizedText = DOMPurify.sanitize(data.explanation); // يتطلب تضمين مكتبة DOMPurify
                        contentEl.innerHTML = sanitizedText.replace(/\n/g, '<br>'); // Display newlines as breaks
                    } else {
                        throw new Error("Invalid response structure from backend.");
                    }

                } catch (error) {
                    console.error("AI Explanation Error:", error);
                    contentEl.innerHTML = `<p class="text-red-500">عذراً، حدث خطأ أثناء جلب المعلومات من الذكاء الاصطناعي. يرجى المحاولة لاحقاً.</p>`;
                }
            }

            // SECURITY NOTE: To use DOMPurify, you would need to include it in your HTML:
            // <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.6/purify.min.js"></script>


            /**
             * Renders a modal for rating a doctor.
             * @param {string} doctorId - The UID of the doctor being rated.
             * @param {string} doctorName - The name of the doctor.
             */
            function renderRatingModal(doctorId, doctorName) {
                const modal = document.getElementById('ratingModal');
                let currentRating = 0; // Stores the selected rating

                modal.innerHTML = `
                    <div class="modal-content">
                        <h3 class="text-xl font-bold mb-4 text-center">تقييم الطبيب: ${doctorName}</h3>
                        <div class="rating-stars text-4xl text-center mb-6">
                            <i class="fas fa-star" data-value="1"></i>
                            <i class="fas fa-star" data-value="2"></i>
                            <i class="fas fa-star" data-value="3"></i>
                            <i class="fas fa-star" data-value="4"></i>
                            <i class="fas fa-star" data-value="5"></i>
                        </div>
                        <div class="flex gap-4">
                            <button id="cancel-rating" class="flex-1 bg-gray-300 text-gray-800 font-bold py-3 rounded-lg hover:bg-gray-400">إلغاء</button>
                            <button id="submit-rating" class="flex-1 bg-yellow-500 text-white font-bold py-3 rounded-lg hover:bg-yellow-600" disabled>إرسال التقييم</button>
                        </div>
                    </div>
                `;
                modal.classList.add('active');

                // Event listener for clicking outside the modal content to close it
                modal.addEventListener('click', function handler(e) {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                        modal.removeEventListener('click', handler);
                    }
                });

                const stars = modal.querySelectorAll('.rating-stars .fa-star');
                const submitBtn = modal.querySelector('#submit-rating');

                // Handle star hover effect
                stars.forEach(star => {
                    star.addEventListener('mouseover', (e) => {
                        stars.forEach(s => s.classList.remove('selected')); // Clear all selected
                        e.target.classList.add('selected'); // Select current
                        let prev = e.target.previousElementSibling;
                        while(prev) { // Select previous siblings
                            prev.classList.add('selected');
                            prev = prev.previousElementSibling;
                        }
                    });

                    // Handle star click to set rating
                    star.addEventListener('click', (e) => {
                        currentRating = parseInt(e.target.dataset.value);
                        submitBtn.disabled = false; // Enable submit button
                        stars.forEach(s => {
                            s.classList.toggle('selected', parseInt(s.dataset.value) <= currentRating);
                        });
                    });
                });
                
                // Reset stars to currentRating on mouse leave if no new rating is selected
                modal.querySelector('.rating-stars').addEventListener('mouseleave', () => {
                     stars.forEach(s => {
                        s.classList.toggle('selected', parseInt(s.dataset.value) <= currentRating);
                    });
                });

                modal.querySelector('#cancel-rating').addEventListener('click', () => modal.classList.remove('active'));
                
                submitBtn.addEventListener('click', async () => {
                    if (currentRating === 0) return; // Should be disabled if 0, but as a safeguard
                    showButtonLoading(submitBtn, true, 'إرسال التقييم');

                    const doctorRef = doc(db, `/artifacts/${APP_ID}/users`, doctorId);
                    try {
                        // Use a transaction to safely update rating (prevents race conditions)
                        // SECURITY NOTE: Firestore security rules should also enforce that only
                        // authenticated users can submit ratings, and potentially limit
                        // one rating per patient per doctor.
                        await runTransaction(db, async (transaction) => {
                            const doctorDoc = await transaction.get(doctorRef);
                            if (!doctorDoc.exists()) {
                                throw "Doctor document does not exist!";
                            }
                            const oldRating = doctorDoc.data().rating || { total: 0, count: 0 };
                            const newCount = oldRating.count + 1;
                            const newTotal = oldRating.total + currentRating;
                            transaction.update(doctorRef, { 
                                rating: { total: newTotal, count: newCount }
                            });
                        });
                        showNotification("شكراً لتقييمك!", "success");
                    } catch (error) {
                        console.error("Rating transaction failed: ", error);
                        showNotification("حدث خطأ أثناء إرسال التقييم.", "error");
                    } finally {
                        showButtonLoading(submitBtn, false);
                        modal.classList.remove('active');
                    }
                });
            }
            
            /**
             * Renders a modal for setting up or deactivating 2-Factor Authentication (2FA).
             * @param {string} userId - The UID of the user.
             * @param {boolean} isEnabled - True if 2FA is currently enabled for the user.
             */
            function render2FASetupModal(userId, isEnabled) {
                const modal = document.getElementById('twoFactorAuthModal');
                modal.innerHTML = `
                    <div class="modal-content">
                        <h3 class="text-xl font-bold mb-4">التحقق بخطوتين</h3>
                        ${isEnabled ? `
                            <p class="text-center mb-6">التحقق بخطوتين مفعل حالياً. هل تريد تعطيله؟</p>
                            <div class="flex gap-4">
                                 <button id="cancel-2fa" class="flex-1 bg-gray-300 text-gray-800 font-bold py-3 rounded-lg hover:bg-gray-400">إلغاء</button>
                                 <button id="deactivate-2fa" class="flex-1 bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700">تعطيل</button>
                            </div>
                        ` : `
                            <p class="text-center text-gray-600 mb-4">امسح هذا الرمز باستخدام تطبيق المصادقة الخاص بك.</p>
                            <div id="qrcode" class="p-4 bg-white rounded-lg mb-4"></div>
                            <p class="text-center text-gray-600 mb-4">ثم أدخل الرمز المكون من 6 أرقام لتفعيل الميزة.</p>
                            <input id="2fa-code" type="number" placeholder="ادخل الرمز هنا" class="w-full p-3 border rounded-lg mb-4 text-center tracking-[1rem]">
                            <div class="flex gap-4">
                                 <button id="cancel-2fa" class="flex-1 bg-gray-300 text-gray-800 font-bold py-3 rounded-lg hover:bg-gray-400">إلغاء</button>
                                 <button id="activate-2fa" class="flex-1 bg-teal-600 text-white font-bold py-3 rounded-lg hover:bg-teal-700">تفعيل</button>
                            </div>
                        `}
                    </div>
                `;
                modal.classList.add('active');

                // Event listener for clicking outside the modal content to close it
                modal.addEventListener('click', function handler(e) {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                        modal.removeEventListener('click', handler);
                    }
                });

                if (!isEnabled) {
                    // Generate QR code for TOTP (Time-based One-Time Password)
                    const qr = qrcode(0, 'M');
                    // The secret is simplified for demonstration; in real app, it should be a strong, unique secret
                    // SECURITY NOTE: In a real 2FA implementation, the secret should be generated securely on the server
                    // and stored encrypted. The client-side should only display the QR code.
                    qr.addData(`otpauth://totp/MedicationApp:${userId}?secret=${userId.substring(0,16)}&issuer=MedicationApp`);
                    qr.make();
                    modal.querySelector('#qrcode').innerHTML = qr.createImgTag(4);
                    
                    modal.querySelector('#activate-2fa').addEventListener('click', async (e) => {
                        const activateBtn = e.currentTarget;
                        showButtonLoading(activateBtn, true, 'تفعيل');
                        // SECURITY NOTE: In a real app, you'd verify the 6-digit code using a library like 'otp-generator' on the backend.
                        // For this simulation, we just activate it. The code entered here is not actually verified.
                        try {
                            await updateDoc(doc(db, `/artifacts/${APP_ID}/users`, userId), { is2FAEnabled: true });
                            showNotification("تم تفعيل التحقق بخطوتين بنجاح.", "success");
                            modal.classList.remove('active');
                            // Re-render profile tab to update button text and state
                            const userDoc = await getDoc(doc(db, `/artifacts/${APP_ID}/users`, userId));
                            renderPatientProfileTab(document.getElementById('tab-profile'), auth.currentUser, userDoc.data());
                        } catch (error) {
                            console.error("Error activating 2FA:", error);
                            showNotification("حدث خطأ أثناء تفعيل التحقق بخطوتين.", "error");
                        } finally {
                            showButtonLoading(activateBtn, false);
                        }
                    });
                } else {
                     modal.querySelector('#deactivate-2fa').addEventListener('click', async (e) => {
                        const deactivateBtn = e.currentTarget;
                        showButtonLoading(deactivateBtn, true, 'تعطيل');
                        try {
                            await updateDoc(doc(db, `/artifacts/${APP_ID}/users`, userId), { is2FAEnabled: false });
                            showNotification("تم تعطيل التحقق بخطوتين.", "success");
                            modal.classList.remove('active');
                            const userDoc = await getDoc(doc(db, `/artifacts/${APP_ID}/users`, userId));
                            renderPatientProfileTab(document.getElementById('tab-profile'), auth.currentUser, userDoc.data());
                        } catch (error) {
                            console.error("Error deactivating 2FA:", error);
                            showNotification("حدث خطأ أثناء تعطيل التحقق بخطوتين.", "error");
                        } finally {
                            showButtonLoading(deactivateBtn, false);
                        }
                    });
                }

                modal.querySelector('#cancel-2fa').addEventListener('click', () => modal.classList.remove('active'));
            }

            // --- 10. INITIAL VIEWS & AUTH HANDLERS ---

            /**
             * Renders the initial home view where the user selects their role.
             */
            function renderHomeView() {
                views.home.innerHTML = `
                    <div class="min-h-screen flex flex-col items-center justify-center bg-teal-500 text-white p-4 text-center">
                        <i class="fas fa-pills text-6xl mb-4"></i>
                        <h1 class="text-5xl font-bold mb-2">مساعدك الدوائي الذكي</h1>
                        <p class="text-xl text-teal-100 mb-10 max-w-2xl">التزم بعلاجك بسهولة، وابق على تواصل دائم مع طبيبك.</p>
                        <div class="flex flex-col md:flex-row gap-4">
                            <button data-role="patient" class="role-selection-btn bg-white text-teal-600 font-bold py-3 px-8 rounded-full shadow-lg transform hover:scale-105 transition-transform">أنا مريض</button>
                            <button data-role="doctor" class="role-selection-btn border-2 border-white text-white font-bold py-3 px-8 rounded-full transform hover:scale-105 hover:bg-white hover:text-teal-600 transition-all">أنا طبيب</button>
                        </div>
                    </div>`;
                
                views.home.querySelectorAll('.role-selection-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        appState.currentAuthRole = btn.dataset.role; // Update global state
                        renderAuthView();
                        showView('auth');
                    });
                });
            }

            /**
             * Renders the authentication (login/signup) view.
             */
            function renderAuthView() {
                views.auth.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center p-4 bg-gray-100">
                        <div class="max-w-md w-full bg-white p-8 rounded-2xl shadow-lg">
                            <button class="back-to-home text-gray-500 hover:text-teal-600 mb-4"><i class="fas fa-arrow-right"></i> عودة</button>
                            <h2 class="text-3xl font-bold text-center mb-2">مرحباً بك</h2>
                            <p class="text-center text-teal-600 font-semibold mb-6">الدخول كـ <span id="roleText">${appState.currentAuthRole === 'patient' ? 'مريض' : 'طبيب'}</span></p>
                            <div id="authError" class="text-red-500 text-center mb-4 font-medium min-h-[2.5rem]"></div>
                            <form id="authForm" class="space-y-4">
                                <input type="email" id="emailInput" placeholder="البريد الإلكتروني" class="w-full px-4 py-3 border rounded-lg" required>
                                <input type="password" id="passwordInput" placeholder="كلمة المرور" class="w-full px-4 py-3 border rounded-lg" required>
                            </form>
                            <div class="flex gap-4 mt-6">
                                <button id="loginButton" class="flex-1 bg-teal-600 text-white font-bold py-3 rounded-lg hover:bg-teal-700">دخول</button>
                                <button id="signupButton" class="flex-1 bg-gray-200 text-teal-600 font-bold py-3 rounded-lg hover:bg-gray-300">تسجيل جديد</button>
                            </div>
                            <div class="text-center mt-4">
                                <button id="goToResetPassword" class="text-sm text-teal-600 hover:underline">نسيت كلمة السر؟</button>
                            </div>
                        </div>
                    </div>`;
                
                views.auth.querySelector('.back-to-home').addEventListener('click', () => showView('home'));
                views.auth.querySelector('#goToResetPassword').addEventListener('click', () => {
                    renderResetPasswordView();
                    showView('resetPassword');
                });
                views.auth.querySelector('#signupButton').addEventListener('click', handleSignup);
                views.auth.querySelector('#loginButton').addEventListener('click', handleLogin);
            }

            /**
             * Renders the password reset view.
             */
            function renderResetPasswordView() {
                views.resetPassword.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center p-4 bg-gray-100">
                        <div class="max-w-md w-full bg-white p-8 rounded-2xl shadow-lg">
                            <button class="back-to-auth text-gray-500 hover:text-teal-600 mb-4"><i class="fas fa-arrow-right"></i> عودة</button>
                            <h2 class="text-3xl font-bold text-center mb-2">إعادة تعيين كلمة السر</h2>
                            <p id="resetMessage" class="text-center mb-4 font-medium min-h-[4rem] text-gray-600">أدخل بريدك الإلكتروني المسجل وسنرسل لك رابطاً لإعادة التعيين.</p>
                            <form id="resetForm">
                                <input type="email" id="resetEmailInput" placeholder="البريد الإلكتروني المسجل" class="w-full px-4 py-3 border rounded-lg" required>
                                <button type="submit" id="sendResetLinkBtn" class="mt-6 w-full bg-teal-600 text-white font-bold py-3 rounded-lg hover:bg-teal-700">إرسال رابط</button>
                            </form>
                        </div>
                    </div>`;
                views.resetPassword.querySelector('.back-to-auth').addEventListener('click', () => showView('auth'));
                views.resetPassword.querySelector('#resetForm').addEventListener('submit', handlePasswordReset);
            }

            /**
             * Handles user signup.
             */
            async function handleSignup(e) {
                const email = views.auth.querySelector('#emailInput').value.trim();
                const password = views.auth.querySelector('#passwordInput').value.trim();
                const authErrorEl = views.auth.querySelector('#authError');
                const signupBtn = e.currentTarget;
                authErrorEl.textContent = '';

                // SECURITY NOTE: Client-side validation is for UX. Server-side validation
                // (e.g., Firebase Authentication's built-in checks) is crucial.
                if (!email || !password) { 
                    authErrorEl.textContent = 'الرجاء ملء كل الحقول.'; 
                    return; 
                }
                showButtonLoading(signupBtn, true, 'تسجيل جديد');

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const userDocRef = doc(db, `/artifacts/${APP_ID}/users`, userCredential.user.uid);
                    await setDoc(userDocRef, {
                        email: userCredential.user.email,
                        role: appState.currentAuthRole, // Use current role from state
                        createdAt: serverTimestamp(),
                        linkedPatients: [],
                        linkedDoctors: []
                    });
                    // onAuthStateChanged will handle view transition
                } catch (error) {
                    showButtonLoading(signupBtn, false);
                    console.error("Signup Error:", error.code);
                    switch (error.code) {
                        case 'auth/email-already-in-use':
                            authErrorEl.textContent = 'هذا البريد الإلكتروني مسجل بالفعل.';
                            break;
                        case 'auth/weak-password':
                            authErrorEl.textContent = 'كلمة المرور ضعيفة جداً. يجب أن تتكون من 6 أحرف على الأقل.';
                            break;
                        case 'auth/invalid-email':
                            authErrorEl.textContent = 'صيغة البريد الإلكتروني الذي أدخلته غير صحيحة.';
                            break;
                        default:
                            authErrorEl.textContent = 'حدث خطأ غير متوقع أثناء محاولة التسجيل.';
                            break;
                    }
                }
            }

            /**
             * Handles user login.
             */
            async function handleLogin(e) {
                const email = views.auth.querySelector('#emailInput').value.trim();
                const password = views.auth.querySelector('#passwordInput').value.trim();
                const authErrorEl = views.auth.querySelector('#authError');
                const loginBtn = e.currentTarget;
                authErrorEl.textContent = '';

                // SECURITY NOTE: Client-side validation is for UX. Firebase Authentication
                // handles the actual credential validation securely on the server.
                if (!email || !password) { 
                    authErrorEl.textContent = 'الرجاء ملء كل الحقول.'; 
                    return; 
                }
                showButtonLoading(loginBtn, true, 'دخول');

                try {
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    const userDocRef = doc(db, `/artifacts/${APP_ID}/users`, userCredential.user.uid);
                    const userDoc = await getDoc(userDocRef);
                    if (userDoc.exists() && userDoc.data().role !== appState.currentAuthRole) {
                        // If user tries to log in with the wrong role, sign out and show error
                        await signOut(auth);
                        showButtonLoading(loginBtn, false);
                        const wrongRole = userDoc.data().role === 'patient' ? 'مريض' : 'طبيب';
                        authErrorEl.textContent = `هذا الحساب مسجل كـ '${wrongRole}'. الرجاء العودة واختيار الدور الصحيح.`;
                    }
                    // onAuthStateChanged will handle view transition if login is successful and role matches
                } catch (error) {
                    showButtonLoading(loginBtn, false);
                    console.error("Login Error:", error.code);
                    switch (error.code) {
                        case 'auth/user-not-found':
                        case 'auth/wrong-password':
                        case 'auth/invalid-credential':
                            authErrorEl.textContent = 'البريد الإلكتروني أو كلمة المرور غير صحيحة.';
                            break;
                        case 'auth/invalid-email':
                            authErrorEl.textContent = 'صيغة البريد الإلكتروني الذي أدخلته غير صحيحة.';
                            break;
                        case 'auth/too-many-requests':
                            authErrorEl.textContent = 'تم حظر هذا الحساب مؤقتاً بسبب كثرة المحاولات. يرجى المحاولة مرة أخرى لاحقاً.';
                            break;
                        default:
                            authErrorEl.textContent = 'حدث خطأ غير متوقع أثناء محاولة تسجيل الدخول.';
                            break;
                    }
                }
            }

            /**
             * Handles sending a password reset email.
             * @param {Event} e - The form submit event.
             */
            async function handlePasswordReset(e) {
                e.preventDefault();
                const email = document.getElementById('resetEmailInput').value.trim();
                const messageEl = document.getElementById('resetMessage');
                const sendResetLinkBtn = document.getElementById('sendResetLinkBtn');

                if (!email) {
                    messageEl.textContent = 'الرجاء إدخال بريدك الإلكتروني.';
                    messageEl.className = "text-red-500 text-center mb-4 font-medium min-h-[4rem]";
                    return;
                }
                showButtonLoading(sendResetLinkBtn, true, 'إرسال رابط');

                try {
                    await sendPasswordResetEmail(auth, email);
                    messageEl.textContent = "تم إرسال رابط إعادة التعيين إلى بريدك الإلكتروني بنجاح. الرجاء تفقد صندوق الوارد.";
                    messageEl.className = "text-green-600 text-center mb-4 font-medium min-h-[4rem]";
                } catch (error) {
                    console.error("Password Reset Error:", error.code);
                    messageEl.textContent = "حدث خطأ. تأكد من أن البريد الإلكتروني مسجل.";
                    messageEl.className = "text-red-500 text-center mb-4 font-medium min-h-[4rem]";
                } finally {
                    showButtonLoading(sendResetLinkBtn, false);
                }
            }

            // --- 11. GLOBAL EVENT LISTENERS & APP START ---
            
            // Global logout button listener
            document.getElementById('logoutButton').addEventListener('click', () => signOut(auth));
            // Global theme toggle listener
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);

            // On initial load, check for saved theme preference and apply it
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);
            
            // Start the application by showing the home view
            renderHomeView();
            showView('home');
        }
    </script>
    <!-- SECURITY NOTE: Include DOMPurify library for sanitizing user-generated content -->
    <!-- This is crucial if you display any user-provided text or AI-generated text directly as HTML -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.6/purify.min.js"></script>
</body>
</html>